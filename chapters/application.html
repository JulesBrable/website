<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.475">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Romain Avouac et Lino Galiana">

<title>Mise en production de projets data science - Appliquer les concepts étudiés à un projet de data science</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Mise en production de projets data science</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/introduction.html">
 <span class="menu-text">Introduction</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/code-quality.html">
 <span class="menu-text">Qualité du code</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/projects-architecture.html">
 <span class="menu-text">Architecture des projets</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/portability.html">
 <span class="menu-text">Portabilité</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/deployment.html">
 <span class="menu-text">Mise en production</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../chapters/application.html" aria-current="page">
 <span class="menu-text">Application</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-suppléments" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Suppléments</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-suppléments">    
        <li>
    <a class="dropdown-item" href="../chapters/application.html">
 <span class="dropdown-text">Linux 101</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/git.html">
 <span class="dropdown-text">Git</span></a>
  </li>  
    </ul>
  </li>
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#partie-1-qualité-du-script" id="toc-partie-1-qualité-du-script" class="nav-link active" data-scroll-target="#partie-1-qualité-du-script">Partie 1 : qualité du script</a>
  <ul class="collapse">
  <li><a href="#etape-0-forker-le-dépôt-dexemple-et-créer-une-branche-de-travail" id="toc-etape-0-forker-le-dépôt-dexemple-et-créer-une-branche-de-travail" class="nav-link" data-scroll-target="#etape-0-forker-le-dépôt-dexemple-et-créer-une-branche-de-travail">Etape 0: forker le dépôt d’exemple et créer une branche de travail</a></li>
  <li><a href="#etape-1-sassurer-que-le-script-sexécute-correctement" id="toc-etape-1-sassurer-que-le-script-sexécute-correctement" class="nav-link" data-scroll-target="#etape-1-sassurer-que-le-script-sexécute-correctement">Etape 1 : s’assurer que le script s’exécute correctement</a></li>
  <li><a href="#etape-2-utiliser-un-linter-puis-un-formatter" id="toc-etape-2-utiliser-un-linter-puis-un-formatter" class="nav-link" data-scroll-target="#etape-2-utiliser-un-linter-puis-un-formatter">Etape 2: utiliser un <em>linter</em> puis un <em>formatter</em></a></li>
  <li><a href="#etape-3-gestion-des-paramètres" id="toc-etape-3-gestion-des-paramètres" class="nav-link" data-scroll-target="#etape-3-gestion-des-paramètres">Etape 3: gestion des paramètres</a></li>
  <li><a href="#etape-4-adopter-la-programmation-fonctionnelle" id="toc-etape-4-adopter-la-programmation-fonctionnelle" class="nav-link" data-scroll-target="#etape-4-adopter-la-programmation-fonctionnelle">Etape 4 : Adopter la programmation fonctionnelle</a></li>
  </ul></li>
  <li><a href="#partie2" id="toc-partie2" class="nav-link" data-scroll-target="#partie2">Partie 2 : adoption d’une structure modulaire</a>
  <ul class="collapse">
  <li><a href="#etape-1-modularisation" id="toc-etape-1-modularisation" class="nav-link" data-scroll-target="#etape-1-modularisation">Etape 1 : modularisation</a></li>
  <li><a href="#etape-2-adopter-une-architecture-standardisée-de-projet" id="toc-etape-2-adopter-une-architecture-standardisée-de-projet" class="nav-link" data-scroll-target="#etape-2-adopter-une-architecture-standardisée-de-projet">Etape 2 : adopter une architecture standardisée de projet</a>
  <ul class="collapse">
  <li><a href="#etape-3-indiquer-lenvironnement-minimal-de-reproductibilité" id="toc-etape-3-indiquer-lenvironnement-minimal-de-reproductibilité" class="nav-link" data-scroll-target="#etape-3-indiquer-lenvironnement-minimal-de-reproductibilité">Etape 3: indiquer l’environnement minimal de reproductibilité</a></li>
  </ul></li>
  <li><a href="#stockageS3" id="toc-stockageS3" class="nav-link" data-scroll-target="#stockageS3">Etape 4 : stocker les données de manière externe</a></li>
  </ul></li>
  <li><a href="#partie-2bis-packagisation-de-son-projet-optionnel" id="toc-partie-2bis-packagisation-de-son-projet-optionnel" class="nav-link" data-scroll-target="#partie-2bis-packagisation-de-son-projet-optionnel">Partie 2bis: packagisation de son projet (optionnel)</a>
  <ul class="collapse">
  <li><a href="#etape-1-proposer-des-tests-unitaires-optionnel" id="toc-etape-1-proposer-des-tests-unitaires-optionnel" class="nav-link" data-scroll-target="#etape-1-proposer-des-tests-unitaires-optionnel">Etape 1 : proposer des tests unitaires (optionnel)</a></li>
  <li><a href="#etape-2-transformer-son-projet-en-package-optionnel" id="toc-etape-2-transformer-son-projet-en-package-optionnel" class="nav-link" data-scroll-target="#etape-2-transformer-son-projet-en-package-optionnel">Etape 2 : transformer son projet en package (optionnel)</a></li>
  </ul></li>
  <li><a href="#partie3" id="toc-partie3" class="nav-link" data-scroll-target="#partie3">Partie 2 : construction d’un projet portable et reproductible</a>
  <ul class="collapse">
  <li><a href="#configyaml" id="toc-configyaml" class="nav-link" data-scroll-target="#configyaml">Etape 1: créer un répertoire de variables servant d’input</a>
  <ul class="collapse">
  <li><a href="#enjeu" id="toc-enjeu" class="nav-link" data-scroll-target="#enjeu">Enjeu</a></li>
  <li><a href="#application" id="toc-application" class="nav-link" data-scroll-target="#application">Application</a></li>
  </ul></li>
  <li><a href="#anaconda" id="toc-anaconda" class="nav-link" data-scroll-target="#anaconda">Etape 2 : créer un environnement conda à partir du fichier <code>environment.yml</code></a></li>
  <li><a href="#docker" id="toc-docker" class="nav-link" data-scroll-target="#docker">Etape 3: conteneuriser avec Docker <i class="fab fa-docker"></i></a>
  <ul class="collapse">
  <li><a href="#préliminaire" id="toc-préliminaire" class="nav-link" data-scroll-target="#préliminaire">Préliminaire</a></li>
  <li><a href="#création-dun-premier-dockerfile" id="toc-création-dun-premier-dockerfile" class="nav-link" data-scroll-target="#création-dun-premier-dockerfile">Création d’un premier Dockerfile</a></li>
  <li><a href="#construire-limage" id="toc-construire-limage" class="nav-link" data-scroll-target="#construire-limage">Construire l’image</a></li>
  <li><a href="#tester-limage-découverte-du-cache" id="toc-tester-limage-découverte-du-cache" class="nav-link" data-scroll-target="#tester-limage-découverte-du-cache">Tester l’image: découverte du cache</a></li>
  <li><a href="#corriger-une-faille-de-reproductibilité" id="toc-corriger-une-faille-de-reproductibilité" class="nav-link" data-scroll-target="#corriger-une-faille-de-reproductibilité">Corriger une faille de reproductibilité</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#partie-3-mise-en-production" id="toc-partie-3-mise-en-production" class="nav-link" data-scroll-target="#partie-3-mise-en-production">Partie 3 : mise en production</a>
  <ul class="collapse">
  <li><a href="#etape-préliminaire" id="toc-etape-préliminaire" class="nav-link" data-scroll-target="#etape-préliminaire">Etape préliminaire</a></li>
  <li><a href="#etape-1-mise-en-place-de-tests-automatisés" id="toc-etape-1-mise-en-place-de-tests-automatisés" class="nav-link" data-scroll-target="#etape-1-mise-en-place-de-tests-automatisés">Etape 1: mise en place de tests automatisés</a></li>
  <li><a href="#etape-2-automatisation-de-la-livraison-de-limage-docker" id="toc-etape-2-automatisation-de-la-livraison-de-limage-docker" class="nav-link" data-scroll-target="#etape-2-automatisation-de-la-livraison-de-limage-docker">Etape 2: Automatisation de la livraison de l’image <code>Docker</code></a></li>
  <li><a href="#etape-3-création-dun-rapport-automatique" id="toc-etape-3-création-dun-rapport-automatique" class="nav-link" data-scroll-target="#etape-3-création-dun-rapport-automatique">Etape 3: création d’un rapport automatique</a>
  <ul class="collapse">
  <li><a href="#rapport-minimal-en-local" id="toc-rapport-minimal-en-local" class="nav-link" data-scroll-target="#rapport-minimal-en-local">1. Rapport minimal en local</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#feature-importance" id="toc-feature-importance" class="nav-link" data-scroll-target="#feature-importance">Feature importance</a></li>
  <li><a href="#qualité-prédictive-du-modèle" id="toc-qualité-prédictive-du-modèle" class="nav-link" data-scroll-target="#qualité-prédictive-du-modèle">Qualité prédictive du modèle</a>
  <ul class="collapse">
  <li><a href="#enrichir-limage-docker" id="toc-enrichir-limage-docker" class="nav-link" data-scroll-target="#enrichir-limage-docker">3. Enrichir l’image <code>Docker</code></a></li>
  <li><a href="#automatisation-avec-github-actions" id="toc-automatisation-avec-github-actions" class="nav-link" data-scroll-target="#automatisation-avec-github-actions">4. Automatisation avec <code>Github Actions</code></a></li>
  <li><a href="#etape-4-déploiement-de-ce-rapport-automatique-sur-le-web" id="toc-etape-4-déploiement-de-ce-rapport-automatique-sur-le-web" class="nav-link" data-scroll-target="#etape-4-déploiement-de-ce-rapport-automatique-sur-le-web">Etape 4: Déploiement de ce rapport automatique sur le web</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Appliquer les concepts étudiés à un projet de data science</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Romain Avouac et Lino Galiana </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<p>L’objectif de cette mise en application est d’<strong>illustrer les différentes étapes qui séparent la phase de développement d’un projet de celle de la mise en production</strong>. Elle permettra de mettre en pratique les différents concepts présentés tout au long du cours.</p>
<p>Nous nous plaçons dans une situation initiale correspondant à la fin de la phase de développement d’un projet de data science. On a un notebook un peu monolithique, qui réalise les étapes classiques d’un <em>pipeline</em> de <em>machine learning</em> :</p>
<ul>
<li>Import de données ;</li>
<li>Statistiques descriptives et visualisations ;</li>
<li><em>Feature engineering</em> ;</li>
<li>Entraînement d’un modèle ;</li>
<li>Evaluation du modèle</li>
</ul>
<p><strong>L’objectif est d’améliorer le projet de manière incrémentale jusqu’à pouvoir le mettre en production, en le valorisant sous une forme adaptée.</strong></p>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Il est important de bien lire les consignes et d’y aller progressivement. Certaines étapes peuvent être rapides, d’autres plus fastidieuses ; certaines être assez guidées, d’autres vous laisser plus de liberté. Si vous n’effectuez pas une étape, vous risquez de ne pas pouvoir passer à l’étape suivante qui en dépend.</p>
<p>Bien que l’exercice soit applicable sur toute configuration bien faite, nous recommandons de privilégier l’utilisation du <a href="https://datalab.sspcloud.fr/home">SSP Cloud</a>, où tous les outils nécessaires sont pré-installés et pré-configurés.</p>
</div>
</div>
<section id="partie-1-qualité-du-script" class="level1">
<h1>Partie 1 : qualité du script</h1>
<p>Cette première partie vise à <strong>rendre le projet conforme aux bonnes pratiques</strong> présentées dans le cours.</p>
<p>Elle fait intervenir les notions suivantes :</p>
<ul>
<li>Utilisation du <strong>terminal</strong> (voir <a href="../chapters/linux-101.html">Linux 101</a>) ;</li>
<li><strong>Qualité du code</strong> (voir <a href="../chapters/code-quality.html">Qualité du code</a>) ;</li>
<li><strong>Architecture de projets</strong> (voir <a href="../chapters/projects-architecture.html">Architecture des projets</a>) ;</li>
<li><strong>Contrôle de version</strong> avec <code>Git</code> (voir <a href="../chapters/git.html">Rappels <code>Git</code></a>) ;</li>
<li><strong>Travail collaboratif</strong> avec <code>Git</code> et <code>GitHub</code> (voir <a href="../chapters/git.html">Rappels <code>Git</code></a>).</li>
</ul>
<p>Le plan de la partie est le suivant :</p>
<!----
0. :zero: _Forker_ le dépôt et créer une branche de travail
1. :one: S'assurer que le _notebook_ s'exécute correctement
2. :two: Modularisation : mise en fonctions et mise en module
3. :three: Utiliser un `main` script
4. :four:  Appliquer les standards de qualité de code
5. :five: Adopter une architecture standardisée de projet
6. :six: Fixer l'environnement d'exécution
7. :seven: Stocker les données de manière externe
8. :eight: Nettoyer le projet `Git`
9. :nine: Ouvrir une *pull request* sur le dépôt du projet.
------------->
<p>Nous allons partir de ce <em>Notebook</em> <code>Jupyter</code>, que vous pouvez prévisualiser voire tester en cliquant sur l’un des liens suivants:</p>
<p><a href="https://datalab.sspcloud.fr/launcher/ide/jupyter-python?autoLaunch=false&amp;init.personalInit=%C2%ABhttps%3A%2F%2Fraw.githubusercontent.com%2Flinogaliana%2Fensae-reproductibilite-website%2Fmaster%2Fpreview-notebook.sh%C2%BB" target="_blank" rel="noopener"><img src="https://img.shields.io/badge/SSPcloud-Tester%20notebook%20sur%20SSP--cloud-informational&amp;color=yellow?logo=Python" alt="Onyxia"></a> <a href="http://colab.research.google.com/github/linogaliana/ensae-reproductibilite-application/blob/main/titanic.ipynb" target="_blank" rel="noopener"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"></a></p>
<section id="etape-0-forker-le-dépôt-dexemple-et-créer-une-branche-de-travail" class="level2">
<h2 class="anchored" data-anchor-id="etape-0-forker-le-dépôt-dexemple-et-créer-une-branche-de-travail">Etape 0: forker le dépôt d’exemple et créer une branche de travail</h2>
<ul>
<li><p>Ouvrir un service <code>VSCode</code> sur le <a href="https://datalab.sspcloud.fr/home">SSP Cloud</a>. Vous pouvez aller dans la page <code>My Services</code> et cliquer sur <code>New service</code>. Sinon, vous pouvez lancer le service en cliquant directement <a href="https://datalab.sspcloud.fr/launcher/ide/vscode-python?autoLaunch=false">ici</a>.</p></li>
<li><p>Générer un jeton d’accès (<em>token</em>) sur <code>GitHub</code> afin de permettre l’authentification en ligne de commande à votre compte. La procédure est décrite <a href="https://docs.sspcloud.fr/onyxia-guide/controle-de-version#creer-un-jeton-dacces-token">ici</a>. Garder le jeton généré de côté.</p></li>
<li><p>Forker le dépôt <code>Github</code> : https://github.com/linogaliana/ensae-reproductibilite-application</p></li>
<li><p>Clôner <strong>votre</strong> dépôt <code>Github</code> en utilisant le terminal depuis <code>Visual Studio</code> (<code>Terminal &gt; New Terminal</code>) :</p></li>
</ul>
<pre class="shell"><code>$ git clone https://&lt;TOKEN&gt;@github.com/&lt;USERNAME&gt;/ensae-reproductibilite-application.git</code></pre>
<p>où <code>&lt;TOKEN&gt;</code> et <code>&lt;USERNAME&gt;</code> sont à remplacer, respectivement, par le jeton que vous avez généré précédemment et votre nom d’utilisateur.</p>
<ul>
<li>Se placer avec le terminal dans le dossier en question :</li>
</ul>
<pre class="shell"><code>$ cd ensae-reproductibilite-application</code></pre>
<ul>
<li>Créez une branche <code>nettoyage</code> :</li>
</ul>
<pre class="shell"><code>$ git checkout -b nettoyage
Switched to a new branch 'nettoyage'</code></pre>
</section>
<section id="etape-1-sassurer-que-le-script-sexécute-correctement" class="level2">
<h2 class="anchored" data-anchor-id="etape-1-sassurer-que-le-script-sexécute-correctement">Etape 1 : s’assurer que le script s’exécute correctement</h2>
<p>On va partir du fichier <code>notebook.py</code> qui reprend le contenu du <em>notebook</em><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> mais dans un script classique.</p>
<p>La première étape est simple, mais souvent oubliée : <strong>vérifier que le code fonctionne correctement</strong>.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Application 1: corriger les erreurs
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Ouvrir dans <code>VSCode</code> le script <code>titanic.py</code> ;</li>
<li>Exécuter le script ligne à ligne pour détecter les erreurs ;</li>
<li>Corriger les deux erreurs qui empêchent la bonne exécution ;</li>
<li>Vérifier le fonctionnement du script en utilisant la ligne de commande</li>
</ul>
<pre class="shell"><code>python titanic.py</code></pre>
</div>
</div>
<p>Il est maintenant temps de <em>commit</em> les changements effectués avec <code>Git</code><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> :</p>
<pre class="shell"><code>$ git add titanic.py
$ git commit -m "Corrige l'erreur qui empêchait l'exécution"
$ git push</code></pre>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application1/titanic.py">Script <em>checkpoint</em></a></p>
</div>
</div>
</div>
</section>
<section id="etape-2-utiliser-un-linter-puis-un-formatter" class="level2">
<h2 class="anchored" data-anchor-id="etape-2-utiliser-un-linter-puis-un-formatter">Etape 2: utiliser un <em>linter</em> puis un <em>formatter</em></h2>
<p>On va maintenant améliorer la qualité de notre code en appliquant les standards communautaires. Pour cela, on va utiliser le <em>linter</em> classique <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a>.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>N’hésitez pas à taper un code d’erreur sur un moteur de recherche pour obtenir plus d’informations si jamais le message n’est pas clair !</p>
</div>
</div>
<p>Pour appliquer le <em>linter</em> à un script <code>.py</code>, la syntaxe à entrer dans le terminal est la suivante :</p>
<pre class="shell"><code>$ pylint mon_script.py</code></pre>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p><a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> et <a href="https://black.readthedocs.io/en/stable/"><code>Black</code></a> sont des <em>packages</em> <code>Python</code> qui s’utilisent principalement en ligne de commande.</p>
<p>Si vous avez une erreur qui suggère que votre terminal ne connait pas <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> ou <a href="https://black.readthedocs.io/en/stable/"><code>Black</code></a>, n’oubliez pas d’exécuter la commande <code>pip install pylint</code> ou <code>pip install black</code>.</p>
</div>
</div>
<p>Le <em>linter</em> renvoie alors une série d’irrégularités, en précisant à chaque fois la ligne de l’erreur et le message d’erreur associé (ex : mauvaise identation). Il renvoie finalement une note sur 10, qui estime la qualité du code à l’aune des standards communautaires évoqués dans la partie <a href="../chapters/code-quality.html">Qualité du code</a>.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Application 2: rendre lisible le script
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Diagnostiquer et évaluer la qualité de <code>titanic.py</code> avec <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a>. Regarder la note obtenue.</li>
<li>Utiliser <code>black titanic.py --diff --color</code> pour observer les changements de forme que va induire l’utilisation du <em>formatter</em> <a href="https://black.readthedocs.io/en/stable/"><code>Black</code></a></li>
<li>Appliquer le <em>formatter</em> <a href="https://black.readthedocs.io/en/stable/"><code>Black</code></a></li>
<li>Réutiliser <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> pour diagnostiquer l’amélioration de la qualité du script et le travail qui reste à faire.</li>
<li>Comme la majorité du travail restant est à consacrer aux imports:
<ul>
<li>Mettre tous les <em>imports</em> ensemble en début de script</li>
<li>Retirer les <em>imports</em> redondants en s’aidant des diagnostics de votre éditeur</li>
<li>Réordonner les <em>imports</em> si <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> vous indique de le faire</li>
<li>Corriger les dernières fautes formelles suggérées par <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a></li>
</ul></li>
<li>Délimiter des parties dans votre code pour rendre sa structure plus lisible</li>
</ul>
</div>
</div>
<p>Le code est maintenant lisible, il obtient à ce stade une note formelle proche de 10. Mais il n’est pas encore totalement intelligible ou fiable. Il y a notamment beaucoup de redondance de code auxquelles nous allons nous attaquer par la suite. Néanmoins, avant cela, occupons-nous de mieux gérer certains paramètres du script: jetons d’API et chemin des fichiers.</p>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application2/titanic.py"><code>titanic.py</code></a></p>
</div>
</div>
</div>
</section>
<section id="etape-3-gestion-des-paramètres" class="level2">
<h2 class="anchored" data-anchor-id="etape-3-gestion-des-paramètres">Etape 3: gestion des paramètres</h2>
<p>L’exécution du code et les résultats obtenus dépendent de certains paramètres. L’étude de résultats alternatifs, en jouant sur des variantes des paramètres, est à ce stade compliquée car il est nécessaire de parcourir le code pour trouver ces paramètres. De plus, certains paramètres personnels comme des jetons d’API ou des mots de passe n’ont pas vocation à être présents dans le code.</p>
<p>Il est plus judicieux de considérer ces paramètres comme des variables d’entrée du script. Cela peut être fait de deux manières:</p>
<ol type="1">
<li>Avec des arguments optionnels appelés depuis la ligne de commande. Cela peut être pratique pour mettre en oeuvre des tests automatisés<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> mais n’est pas forcément pertinent pour toutes les variables. Nous allons montrer cet usage avec le nombre d’arbres de notre <em>random forest</em> ;</li>
<li>En utilisant un fichier de configuration dont les valeurs sont importées dans le script principal. Nous allons le mettre en oeuvre pour deux types de fichiers: les éléments de configuration à partager et ceux à conserver pour soi mais pouvant servir.</li>
</ol>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Application 3: Paramétrisation du script
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>En s’inspirant de <a href="https://stackoverflow.com/a/69377311/9197726">cette réponse</a>, créer une variable <code>n_trees</code> qui peut éventuellement être paramétrée en ligne de commande et dont la valeur par défaut est 20.</li>
<li>Tester cette paramétrisation en ligne de commande avec la valeur par défaut puis 2, 10 et 50 arbres</li>
<li>Repérer le jeton d’API dans le code. Retirer le jeton d’API du code et créer à la racine du projet un fichier YAML nommé <code>secrets.yaml</code> où vous écrivez ce secret sous la forme <code>key: value</code></li>
<li>Pour éviter d’avoir à le faire plus tard, créer une fonction <code>import_yaml_config</code> qui prend en argument le chemin d’un fichier <code>YAML</code> et renvoie le contenu de celui-ci en <em>output</em>. Vous pouvez suivre le conseil du chapitre sur la <a href="../chapters/code-quality.html">Qualité du code</a> en adoptant le <em>type hinting</em>.</li>
<li>Créer la variable <code>API_TOKEN</code> ayant la valeur stockée dans <code>secrets.yaml</code><a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>.</li>
<li>Tester en ligne de commande que l’exécution du fichier est toujours sans erreur</li>
<li>Refaire un diagnostic avec <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> et corriger les éventuels messages.</li>
<li>Créer un fichier <code>config.yaml</code> stockant trois informations: le chemin des données d’entraînement, des données de test et la répartition train/test utilisée dans le code. Créer les variables correspondantes dans le code après avoir utilisé <code>import_yaml_config</code></li>
<li>Créer un fichier <code>.gitignore</code>. Ajouter dans ce fichier <code>secrets.yaml</code> car il ne faut pas committer ce fichier.</li>
<li>Créer un fichier <code>README.md</code> où vous indiquez qu’il faut créer un fichier <code>secrets.yaml</code> pour pouvoir utiliser l’API.</li>
</ol>
<details>
<summary>
Indice si vous ne trouvez pas comment lire un fichier <code>YAML</code>
</summary>
<p>Si le fichier s’appelle <code>toto.yaml</code>, vous pouvez l’importer de cette manière:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">"toto.yaml"</span>, <span class="st">"r"</span>, encoding<span class="op">=</span><span class="st">"utf-8"</span>) <span class="im">as</span> stream:</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    dict_config <span class="op">=</span> yaml.safe_load(stream)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/titanic.py"><code>titanic.py</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/readme.md"><code>README.md</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/config.yaml"><code>config.yaml</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/secrets.yaml"><code>secrets.yaml</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/.gitignore"><code>.gitignore</code></a></li>
</ul>
</div>
</div>
</div>
</section>
<section id="etape-4-adopter-la-programmation-fonctionnelle" class="level2">
<h2 class="anchored" data-anchor-id="etape-4-adopter-la-programmation-fonctionnelle">Etape 4 : Adopter la programmation fonctionnelle</h2>
<p>Nous allons <strong>mettre en fonctions les parties importantes de l’analyse, et les mettre dans un module afin de pouvoir les importer directement depuis le notebook</strong>.</p>
<p>Cet exercice étant chronophage, il n’est <strong>pas obligatoire de le réaliser en entier</strong>. L’important est de comprendre la démarche et d’adopter fréquemment une approche fonctionnelle<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>. Pour obtenir une chaine entièrement fonctionnalisée, vous pouvez reprendre le <em>checkpoint</em>.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Application 4: adoption des standards de programmation fonctionnelle
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Créer une fonction qui importe les données d’entraînement (<code>train.csv</code>) et de test (<code>test.csv</code>) et renvoie des <code>DataFrames</code> <code>Pandas</code> ;</li>
<li>En fonction du temps disponible, créer plusieurs fonctions pour réaliser les étapes de <em>feature engineering</em>:
<ul>
<li>La création de la variable <em>“Title”</em> peut être automatisée en vertu du principe <em>“do not repeat yourself”</em><a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>.</li>
<li>Regrouper ensemble les <code>fillna</code> et essayer de créer une fonction généralisant l’opération.</li>
<li>Les <em>label encoders</em> peuvent être transformés en deux fonctions: une première pour encoder une colonne puis une seconde qui utilise la première de manière répétée pour encoder plusieurs colonnes. <em>Remarquez les erreurs de copier-coller que cela corrige</em></li>
<li>Finaliser les dernières transformations avec des fonctions</li>
</ul></li>
<li>Créer une fonction qui réalise le <em>split train/test</em> de validation en fonction d’un paramètre représentant la proportion de l’échantillon de test.</li>
<li>Créer une fonction qui entraîne et évalue un classifieur <code>RandomForest</code>, et qui prend en paramètre le nombre d’arbres (<code>n_estimators</code>). La fonction doit imprimer à la fin la performance obtenue et la matrice de confusion.</li>
<li>Déplacer toutes les fonctions ensemble, en début de script. <!----- plus tard ?
- Mettre ces fonctions dans un module `functions.py`
- importer les fonctions via le module dans le notebook et vérifier que l'on retrouve bien les différents résultats en utilisant les fonctions.
-------></li>
</ul>
</div>
</div>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Le fait d’appliquer des fonctions a déjà amélioré la fiabilité du processus en réduisant le nombre d’erreurs de copier-coller. Néanmoins, pour vraiment fiabiliser le processus, il faudrait utiliser un <em>pipeline</em> de transformations de données.</p>
<p>Ceci n’est pas encore au programme du cours mais le sera dans une prochaine version.</p>
</div>
</div>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-12-contents" aria-controls="callout-12" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-12" class="callout-12-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application4/titanic.py"><code>titanic.py</code></a></li>
</ul>
<p>Les autres fichiers inchangés:</p>
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/readme.md"><code>README.md</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/config.yaml"><code>config.yaml</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/secrets.yaml"><code>secrets.yaml</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/.gitignore"><code>.gitignore</code></a></li>
</ul>
</div>
</div>
</div>
</section>
</section>
<section id="partie2" class="level1">
<h1>Partie 2 : adoption d’une structure modulaire</h1>
<p>Dans la partie précédente, on a appliqué de manière incrémentale de nombreuses bonnes pratiques vues tout au long du cours. Ce faisant, on s’est déjà considérablement rapprochés d’un possible partage du code : celui-ci est lisible et intelligible. Le code est proprement versionné sur un dépôt <code>GitHub</code>.</p>
<p>Néanmoins, la structure du projet n’est pas encore normalisée. De plus, l’adoption d’une structure plus modulaire facilitera la compréhension de la chaine de traitement.</p>
<section id="etape-1-modularisation" class="level2">
<h2 class="anchored" data-anchor-id="etape-1-modularisation">Etape 1 : modularisation</h2>
<p>Fini le temps de l’expérimentation : on va maintenant essayer de se passer complètement du <em>notebook</em>. Pour cela, on va utiliser un <code>main</code> script, c’est à dire un script qui reproduit l’analyse en important et en exécutant les différentes fonctions dans l’ordre attendu.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Application 5: modularisation
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Déplacer les fonctions dans une série de fichiers dédiés:
<ul>
<li><code>import_data.py</code>: fonctions d’import de données</li>
<li><code>build_features.py</code>: fonctions regroupant les étapes de <em>feature engineering</em></li>
<li><code>train_evaluate.py</code>: fonctions d’entrainement et d’évaluation du modèle</li>
</ul></li>
<li>Spécifier les dépendances (i.e.&nbsp;les packages à importer) dans les modules pour que ceux-ci puissent s’exécuter indépendamment ;</li>
<li>Renommer <code>titanic.py</code> en <code>main.py</code> pour suivre la convention de nommage des projets <code>Python</code> ;</li>
<li>Importer les fonctions nécessaires à partir des modules. ⚠️ Ne pas utiliser <code>from XXX import *</code>, ce n’est pas une bonne pratique !</li>
<li>Vérifier que tout fonctionne bien en exécutant le <em>script</em> <code>main</code> à partir de la ligne de commande :</li>
</ul>
<pre class="shell"><code>$ python main.py</code></pre>
</div>
</div>
<p>On dispose maintenant d’une application <code>Python</code> fonctionnelle. Néanmoins, le projet est certes plus fiable mais sa structuration laisse à désirer et il serait difficile de rentrer à nouveau dans le projet dans quelques temps.</p>
<details>
<summary>
Etat actuel du projet 🙈
</summary>
<pre class="shell"><code>├── README.md
├── train.csv
├── test.csv
├── .gitignore
├── config.yaml
├── secrets.yaml
├── import_data.py
├── build_features.py
├── train_evaluate.py
└──main.py</code></pre>
</details>
<p>Comme cela est expliqué dans la partie <a href="../chapters/projects-architecture.html">Structure des projets</a>, on va adopter une structure certes arbitraire mais qui va faciliter l’autodocumentation de notre projet.</p>
<p>De plus, une telle structure va faciliter des évolutions optionnelles comme la packagisation du projet. Passer d’une structure modulaire bien faite à un <em>package</em> est quasi-immédiat en <code>Python</code>.</p>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-14-contents" aria-controls="callout-14" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-14" class="callout-14-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application5/build_features.py"><code>build_features.py</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application5/import_data.py"><code>import_data.py</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application5/train_evaluate.py"><code>train_evaluate.py</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application5/main.py"><code>main.py</code></a></li>
</ul>
<p>Les autres fichiers inchangés:</p>
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/readme.md"><code>README.md</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/config.yaml"><code>config.yaml</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/secrets.yaml"><code>secrets.yaml</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/.gitignore"><code>.gitignore</code></a></li>
</ul>
</div>
</div>
</div>
</section>
<section id="etape-2-adopter-une-architecture-standardisée-de-projet" class="level2">
<h2 class="anchored" data-anchor-id="etape-2-adopter-une-architecture-standardisée-de-projet">Etape 2 : adopter une architecture standardisée de projet</h2>
<p>On va maintenant modifier l’architecture de notre projet pour la rendre plus standardisée. Pour cela, on va s’inspirer des structures <a href="https://cookiecutter.readthedocs.io/en/stable/"><code>cookiecutter</code></a> qui génèrent des <em>templates</em> de projet.</p>
<p>On va s’inspirer de la structure du <a href="https://drivendata.github.io/cookiecutter-data-science/"><em>template datascience</em></a> développé par la communauté.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>L’idée de <a href="https://cookiecutter.readthedocs.io/en/stable/"><code>cookiecutter</code></a> est de proposer des <em>templates</em> que l’on utilise pour <strong>initialiser</strong> un projet, afin de bâtir à l’avance une structure évolutive. La syntaxe à utiliser dans ce cas est la suivante :</p>
<pre class="shell"><code>$ pip install cookiecutter
$ cookiecutter https://github.com/drivendata/cookiecutter-data-science</code></pre>
<p>Ici, on a déjà un projet, on va donc faire les choses dans l’autre sens : on va s’inspirer de la structure proposée afin de réorganiser celle de notre projet selon les standards communautaires.</p>
</div>
</div>
<p>En s’inspirant du <em>cookiecutter data science</em> on va adopter la structure suivante:</p>
<pre class="shell"><code>ensae-reproductibilite-application
├── main.py
├── README.md
├── data
│   └── raw
│       ├── test.csv
│       └── train.csv
├── configuration
│   ├── secrets.yaml
│   └── config.yaml
├── notebooks
│   └── titanic.ipynb
└── src
    ├── data
    │   └── import_data.py
    ├── features
    │   └── build_features.py
    └── models
        └── train_evaluate.py</code></pre>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Application 6: adopter une structure lisible
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><em>(optionnel)</em> Analyser et comprendre la <a href="https://drivendata.github.io/cookiecutter-data-science/#directory-structure">structure de projet</a> proposée par le template</li>
<li>Modifier l’arborescence du projet selon le modèle</li>
<li>Adapter les scripts et les fichiers de configuration à la nouvelle arborescence</li>
<li>Ajouter le dossier <strong>pycache</strong> au <code>.gitignore</code><a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a> et le dossier <code>data</code></li>
</ul>
</div>
</div>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-17-contents" aria-controls="callout-17" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-17" class="callout-17-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application5/build_features.py"><code>build_features.py</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application5/import_data.py"><code>import_data.py</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application5/train_evaluate.py"><code>train_evaluate.py</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application5/main.py"><code>main.py</code></a></li>
</ul>
<p>Les autres fichiers sont inchangés, à l’exception de leur emplacement.</p>
</div>
</div>
</div>
<section id="etape-3-indiquer-lenvironnement-minimal-de-reproductibilité" class="level3">
<h3 class="anchored" data-anchor-id="etape-3-indiquer-lenvironnement-minimal-de-reproductibilité">Etape 3: indiquer l’environnement minimal de reproductibilité</h3>
<p>Le script <code>main.py</code> nécessite un certain nombre de packages pour être fonctionnel. Chez vous les packages nécessaires sont bien sûr installés mais êtes-vous assuré que c’est le cas chez la personne qui testera votre code ?</p>
<p>Afin de favoriser la portabilité du projet, il est d’usage de <em>“fixer l’environnement”</em>, c’est-à-dire d’indiquer dans un fichier toutes les dépendances utilisées ainsi que leurs version. Nous proposons de créer un fichier <code>requirements.txt</code> minimal, sur lequel nous reviendrons dans la partie consacrée aux environnements reproductibles.</p>
<p>Le fichier <code>requirements.txt</code> est conventionnellement localisé à la racine du projet. Ici on ne va pas fixer les versions, on raffinera ce fichier plus tard.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Application 7: création du <code>requirements.txt</code>
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Créer un fichier <code>requirements.txt</code> avec la liste des packages nécessaires</li>
<li>Ajouter une indication dans <code>README.md</code> sur l’installation des <em>packages</em> grâce au fichier <code>requirements.txt</code></li>
</ul>
</div>
</div>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-19-contents" aria-controls="callout-19" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-19" class="callout-19-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application7/requirements.txt"><code>requirements.txt</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application7/README.md"><code>README.md</code></a></li>
</ul>
</div>
</div>
</div>
</section>
</section>
<section id="stockageS3" class="level2">
<h2 class="anchored" data-anchor-id="stockageS3">Etape 4 : stocker les données de manière externe</h2>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Pour mettre en oeuvre cette étape, il peut être utile de comprendre un peu comme fonctionne le SSP Cloud. Vous devrez suivre la <a href="https://docs.sspcloud.fr/onyxia-guide/stockage-de-donnees">documentation du SSP Cloud</a> pour la réaliser. Une aide-mémoire est également disponible dans le cours de 2e année de l’ENSAE <a href="https://linogaliana-teaching.netlify.app/reads3/#">Python pour la data science</a></p>
</div>
</div>
<p>Comme on l’a vu dans le cours (<a href="../chapters/project-structure.html">partie structure des projets</a>), les données ne sont pas censées être versionnées sur un projet <code>Git</code>.</p>
<p>L’idéal pour éviter cela tout en maintenant la reproductibilité est d’utiliser une solution de stockage externe. On va utiliser pour cela <code>MinIO</code>, la solution de stockage de type <code>S3</code> offerte par le SSP Cloud.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Application 8: utilisation d’un système de stockage distant
</div>
</div>
<div class="callout-body-container callout-body">
<p>A partir de la ligne de commande, utiliser l’utilitaire <a href="https://min.io/docs/minio/linux/reference/minio-mc.html">MinIO</a> pour copier les données <code>data/raw/train.csv</code> et <code>data/raw/test.csv</code> vers votre bucket personnel, respectivement dans les dossiers <code>ensae-reproductibilite/data/raw/train.csv</code> et <code>ensae-reproductibilite/data/raw/test.csv</code>.</p>
<details>
<summary>
Indice
</summary>
<p>Structure à adopter:</p>
<pre class="shell"><code>$ mc cp data/raw/train.csv s3/&lt;BUCKET_PERSONNEL&gt;/ensae-reproductibilite/data/raw/train.csv
$ mc cp data/raw/test.csv s3/&lt;BUCKET_PERSONNEL&gt;/ensae-reproductibilite/data/raw/test.csv</code></pre>
en modifiant l’emplacement de votre bucket personnel
</details>
<ul>
<li>Pour se simplifier la vie, on va utiliser des URL de téléchargement des fichiers (comme si ceux-ci étaient sur n’importe quel espace de stockage) plutôt que d’utiliser une librairie <code>S3</code> compatible comme <code>boto3</code> ou <code>s3fs</code>. Pour cela, en ligne de commande, faire:</li>
</ul>
<pre class="shell"><code>mc anonymous set download s3/&lt;BUCKET_PERSONNEL&gt;/ensae-reproductibilite/data/raw/</code></pre>
<p>en modifiant <code>&lt;BUCKET_PERSONNEL&gt;</code>. Les URL de téléchargement seront de la forme <code>https://minio.lab.sspcloud.fr/&lt;BUCKET_PERSONNEL&gt;/ensae-reproductibilite/data/raw/test.csv</code> et <code>https://minio.lab.sspcloud.fr/&lt;BUCKET_PERSONNEL&gt;/ensae-reproductibilite/data/raw/train.csv</code></p>
<ul>
<li>Modifier <code>configuration.yaml</code> pour utiliser directement les URL dans l’import</li>
<li>Supprimer les fichiers <code>.csv</code> du dossier <code>data</code> de votre projet, on n’en a plus besoin vu qu’on les importe de l’extérieur</li>
<li>Vérifier le bon fonctionnement de votre application</li>
</ul>
</div>
</div>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-22-contents" aria-controls="callout-22" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-22" class="callout-22-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application8/config.yaml"><code>config.yaml</code></a></li>
</ul>
</div>
</div>
</div>
</section>
</section>
<section id="partie-2bis-packagisation-de-son-projet-optionnel" class="level1">
<h1>Partie 2bis: packagisation de son projet (optionnel)</h1>
<p>Cette série d’actions n’est pas forcément pertinente pour tous les projets. Elle fait un peu la transition entre la modularité et la portabilité.</p>
<section id="etape-1-proposer-des-tests-unitaires-optionnel" class="level2">
<h2 class="anchored" data-anchor-id="etape-1-proposer-des-tests-unitaires-optionnel">Etape 1 : proposer des tests unitaires (optionnel)</h2>
<p>Notre code comporte un certain nombre de fonctions génériques. On peut vouloir tester leur usage sur des données standardisées, différentes de celles du Titanic.</p>
<p>Même si la notion de tests unitaires prend plus de sens dans un <em>package</em>, nous pouvons proposer dans le projet des exemples d’utilisation de la fonction, ceci peut être pédagogique.</p>
<p>Nous allons utiliser <a href="https://docs.python.org/3/library/unittest.html"><code>unittest</code></a> et <code>pytest</code> pour effectuer des tests unitaires. Cette approche nécessite une maîtrise de la programmation orientée objet.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Application 9: test unitaire <em>(optionnel)</em>
</div>
</div>
<div class="callout-body-container callout-body">
<p>Dans le dossier <code>src/data/</code>, créer un fichier <code>test_create_variable_title.py</code><a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>.</p>
<p>En s’inspirant de l’<a href="https://docs.python.org/3/library/unittest.html#basic-example">exemple de base</a>, créer une classe <code>TestCreateVariableTitle</code> qui effectue les opérations suivantes:</p>
<ul>
<li><p>Création d’une fonction <code>test_create_variable_title_default_variable_name</code> qui permet de comparer les objets suivants:</p>
<ul>
<li>Création d’un <code>DataFrame</code> de test :</li>
</ul>
<div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Name'</span>: [<span class="st">'Braund, Mr. Owen Harris'</span>, <span class="st">'Cumings, Mrs. John Bradley (Florence Briggs Thayer)'</span>,</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'Heikkinen, Miss. Laina'</span>, <span class="st">'Futrelle, Mrs. Jacques Heath (Lily May Peel)'</span>,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'Allen, Mr. William Henry'</span>, <span class="st">'Moran, Mr. James'</span>,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'McCarthy, Mr. Timothy J'</span>, <span class="st">'Palsson, Master. Gosta Leonard'</span>,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'Johnson, Mrs. Oscar W (Elisabeth Vilhelmina Berg)'</span>,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'Nasser, Mrs. Nicholas (Adele Achem)'</span>],</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Age'</span>: [<span class="dv">22</span>, <span class="dv">38</span>, <span class="dv">26</span>, <span class="dv">35</span>, <span class="dv">35</span>, <span class="dv">27</span>, <span class="dv">54</span>, <span class="dv">2</span>, <span class="dv">27</span>, <span class="dv">14</span>],</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Survived'</span>: [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>        })</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Utilisation de la fonction <code>create_variable_title</code> sur ce <code>DataFrame</code></li>
<li>Comparaison au <code>DataFrame</code> attendu:</li>
</ul>
<div class="sourceCode" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>expected_result <span class="op">=</span> pd.DataFrame({</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Title'</span>: [<span class="st">'Mr.'</span>, <span class="st">'Mrs.'</span>, <span class="st">'Miss.'</span>, <span class="st">'Mrs.'</span>, <span class="st">'Mr.'</span>, <span class="st">'Mr.'</span>, <span class="st">'Mr.'</span>, <span class="st">'Master.'</span>, <span class="st">'Mrs.'</span>, <span class="st">'Mrs.'</span>],</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Age'</span>: [<span class="dv">22</span>, <span class="dv">38</span>, <span class="dv">26</span>, <span class="dv">35</span>, <span class="dv">35</span>, <span class="dv">27</span>, <span class="dv">54</span>, <span class="dv">2</span>, <span class="dv">27</span>, <span class="dv">14</span>],</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Survived'</span>: [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>        })</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Effectuer le test unitaire en ligne de commande avec <code>unittest</code>. Corriger le test unitaire en cas d’erreur.</p></li>
<li><p>Si le temps le permet, proposer des variantes pour tenir compte de paramètres (comme la variable <code>variable_name</code>) ou d’exceptions (comme la gestion du cas <em>“Dona”</em>)</p></li>
</ul>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Lorsqu’on effectue des tests unitaires, on cherche généralement à tester le plus de lignes possibles de son code. On parle de taux de couverture (<em>coverage rate</em>) pour désigner la statistique mesurant cela.</p>
<p>Cela peut s’effectuer de la manière suivante avec le package <a href="https://coverage.readthedocs.io/en/7.2.2/"><code>coverage</code></a>:</p>
<pre class="shell"><code>$ coverage run -m pytest test_create_variable_title.py
$ coverage report -m

Name                            Stmts   Miss  Cover   Missing
-------------------------------------------------------------
import_data.py                     15      6    60%   16-19, 31-34
test_create_variable_title.py      21      1    95%   54
-------------------------------------------------------------
TOTAL                              36      7    81%</code></pre>
<p>Le taux de couverture est souvent mis en avant par les gros projets comme indicateur de leur qualité. Il existe d’ailleurs des badges <code>Github</code> dédiés.</p>
</div>
</div>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-25-contents" aria-controls="callout-25" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-25" class="callout-25-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application9/test_create_variable_title.py"><code>test_create_variable_title.py</code></a></li>
</ul>
<p>Les autres fichiers sont inchangés.</p>
</div>
</div>
</div>
</section>
<section id="etape-2-transformer-son-projet-en-package-optionnel" class="level2">
<h2 class="anchored" data-anchor-id="etape-2-transformer-son-projet-en-package-optionnel">Etape 2 : transformer son projet en package (optionnel)</h2>
<p>Notre projet est modulaire, ce qui le rend assez simple à transformer en package, en s’inspirant du <code>cookiecutter</code> adapté, issu de <a href="https://py-pkgs.org/03-how-to-package-a-python#package-structure">cet ouvrage</a>.</p>
<details>
<summary>
Structure visée
</summary>
<pre class="shell"><code>ensae-reproductibilite-application
├── docs                                    ┐ 
│   ├── main.py                             │ 
│   └── notebooks                           │ Package documentation and examples
│       ├── titanic.ipynb                   │ 
├── README.md                               ┘ 
├── pyproject.toml                          ┐ 
├── requirements.txt                        │
├── src                                     │
│   └── titanicml                           │ Package source code, metadata,
│       ├── __init__.py                     │ and build instructions 
│       ├── config.yaml                     │
│       ├── import_data.py                  │
│       ├── build_features.py               │ 
│       └── train_evaluate.py               ┘
└── tests                                   ┐
    └── test_create_variable_title.py       ┘ Package tests</code></pre>
</details>
<details>
<summary>
Rappel: structure actuelle
</summary>
<pre class="shell"><code>ensae-reproductibilite-application
├── notebooks                                 
│   └── titanic.ipynb                  
├── configuration                                 
│   └── config.yaml                  
├── main.py                              
├── README.md                 
├── requirements.txt                      
└── src 
    ├── data                                
    │   ├── import_data.py                    
    │   └── test_create_variable_title.py      
    ├── features                           
    │   └── build_features.py      
    └── models                          
        └── train_evaluate.py              </code></pre>
</details>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Application 10: packagisation <em>(optionnel)</em>
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Déplacer les fichiers dans le dossier <code>src</code> pour respecter la nouvelle arborescence ;</li>
<li>Dans <code>src/titanicml</code>, créer un fichier vide <code>__init__.py</code><a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a> ;</li>
<li>Déplacer le fichier de configuration dans le <em>package</em> (nécessaire à la reproductibilité) ;</li>
<li>Créer le dossier <code>docs</code> et mettre les fichiers indiqués dedans</li>
<li>Modifier <code>src/titanicml/import_data.py</code> :
<ul>
<li>Ajouter la variable <code>config_file = os.path.join(os.path.dirname(__file__), "config.yaml")</code>. Cela permettra d’utiliser directement le fichier ;</li>
<li>Proposer un argument par défaut à la fonction <code>import_config_yaml</code> égal à <code>config_file</code></li>
</ul></li>
<li>Créer un fichier <code>pyproject.toml</code> à partir du contenu de <a href="https://github.com/linogaliana/ensae-reproductibilite-application/blob/main/checkpoints/application10/pyproject.toml">ce modèle de <code>pyproject</code></a><a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a></li>
<li>Installer le package en local avec <code>pip install .</code></li>
<li>Modifier le contenu de <code>docs/main.py</code> pour importer les fonctions de notre <em>package</em> <code>titanicml</code> et tester en ligne de commande notre fichier <code>main.py</code></li>
</ul>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Pour créer la structure minimale d’un <em>package</em>, le plus simple est d’utiliser le <code>cookiecutter</code> adapté, issu de <a href="https://py-pkgs.org/03-how-to-package-a-python#package-structure">cet ouvrage</a>.</p>
<p>Comme on a déjà une structure très modulaire, on va plutôt recréer cette structure dans notre projet déjà existant. En fait, il ne manque qu’un fichier essentiel, le principal distinguant un projet classique d’un package : <code>pyproject.toml</code>.</p>
<pre class="shell"><code>cookiecutter https://github.com/py-pkgs/py-pkgs-cookiecutter.git</code></pre>
<details>
<summary>
Dérouler pour voir les choix possibles
</summary>
<pre class="shell"><code>author_name [Monty Python]: Daffy Duck
package_name [mypkg]: titanicml
package_short_description []: Impressive Titanic survival analysis
package_version [0.1.0]: 
python_version [3.9]: 
Select open_source_license:
1 - MIT
2 - Apache License 2.0
3 - GNU General Public License v3.0
4 - Creative Commons Attribution 4.0
5 - BSD 3-Clause
6 - Proprietary
7 - None
Choose from 1, 2, 3, 4, 5, 6 [1]: 
Select include_github_actions:
1 - no
2 - ci
3 - ci+cd
Choose from 1, 2, 3 [1]:</code></pre>
</details>
</div>
</div>
<!-----
## Etape 9 : ouvrir une *pull request* sur le dépôt du projet

Enfin terminé ! Enfin presque... On s'est donné beaucoup de mal à nettoyer ce dépôt et le mettre aux standards, autant valoriser ce travail. On va pour cela faire une *pull request* sur le [dépôt du projet initial](https://github.com/avouacr/ensae-reproductibilite-projet), c'est à dire proposer à l'auteur d'intégrer tous les changements que vous avez effectué en committant à chaque étape. 

Suivre la procédure décrite dans la [documentation GitHub](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request-from-a-fork) pour créer une *pull request* à partir de votre *fork*. Pour la branche *upstream* (le dépôt cible), on va choisir `master`. Par contre, pour la branche locale (celle sur votre dépôt), on va choisir la branche `nettoyage`.

Si tout s'est bien passé, vous devriez à présent voir votre *pull request* sur le dépôt cible ([ici](https://github.com/avouacr/ensae-reproductibilite-projet/pulls)). Bravo, vous venez de faire votre première contribution à l'open source !

{{% box status="warning" title="Warning" icon="fa fa-exclamation-triangle" %}}
Faire une *pull request* via la branche `master` d’un *fork* est très mal vu. En effet, il faut souvent faire des contorsionnements pour réussir à faire coïncider deux histoires qui n’ont pas de raison de coïncider. On s'évite beaucoup de problèmes en prenant l'habitude de toujours faire ses *pull requests* à partir d'une autre branche que `master`.
{{% /box %}}
------------------>
</section>
</section>
<section id="partie3" class="level1">
<h1>Partie 2 : construction d’un projet portable et reproductible</h1>
<p>Dans la partie précédente, on a appliqué de manière incrémentale de nombreuses bonnes pratiques vues tout au long du cours. Ce faisant, on s’est déjà considérablement rapprochés d’une possible mise en production : le code est lisible, la structure du projet est normalisée et évolutive, et le code est proprement versionné sur un dépôt <code>GitHub</code> <i class="fab fa-github"></i>.</p>
<p>A présent, nous avons une version du projet qui est largement partageable. Du moins en théorie, car la pratique est souvent plus compliquée : il y a fort à parier que si vous essayez d’exécuter votre projet sur un autre environnement (typiquement, votre ordinateur personnel), les choses ne se passent pas du tout comme attendu. Cela signifie qu’<strong>en l’état, le projet n’est pas portable : il n’est pas possible, sans modifications coûteuses, de l’exécuter dans un environnement différent de celui dans lequel il a été développé</strong>.</p>
<p>Dans cette seconde partie, nous allons voir comment <strong>normaliser l’environnement d’exécution afin de produire un projet portable</strong>. On sera alors tout proche de pouvoir mettre le projet en production. On progressera dans l’échelle de la reproductibilité de la manière suivante: - <span class="emoji" data-emoji="one">1️⃣</span> <a href="#configyaml"><strong>Gérer des variables d’environnement hors du code</strong></a> ; - <span class="emoji" data-emoji="two">2️⃣</span> <a href="#anaconda"><strong>Environnements virtuels</strong></a> ; - <span class="emoji" data-emoji="three">3️⃣</span> <a href="#docker"><strong>Images et conteneurs <code>Docker</code></strong></a>.</p>
<section id="configyaml" class="level2">
<h2 class="anchored" data-anchor-id="configyaml">Etape 1: créer un répertoire de variables servant d’input</h2>
<section id="enjeu" class="level3">
<h3 class="anchored" data-anchor-id="enjeu">Enjeu</h3>
<p>Lors de l’<a href="#stockageS3">étape 7</a>, nous avons amélioré la qualité du script en séparant stockage et code. Cependant, peut-être avez-vous remarqué que nous avons introduit un nom de <em>bucket</em> personnel dans le script (voir <a href="https://github.com/linogaliana/ensae-reproductibilite-projet-1/blob/v7/main.py#L9">le fichier <code>main.py</code></a>). Il s’agit typiquement du genre de petit vice caché d’un script qui peut générer une erreur: vous n’avez pas accès au bucket en question donc si vous essayez de faire tourner ce script en l’état, vous allez rencontrer une erreur.</p>
<p>Une bonne pratique pour gérer ce type de configuration est d’utiliser un fichier <code>YAML</code> qui stocke de manière hiérarchisée les variables globales <a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a>.</p>
<p>En l’occurrence, nous n’avons besoin que de deux éléments pour pouvoir dé-personnaliser ce script :</p>
<ul>
<li>le nom du bucket</li>
<li>l’emplacement dans le bucket</li>
</ul>
</section>
<section id="application" class="level3">
<h3 class="anchored" data-anchor-id="application">Application</h3>
<p>Dans <code>VSCode</code>, créer un fichier nommé <code>config.yaml</code> et le localiser à la racine de votre dépôt. Voici, une proposition de hiérarchisation de l’information que vous devez adapter à votre nom d’utilisateur :</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">input</span><span class="kw">:</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">bucket</span><span class="kw">:</span><span class="at"> </span><span class="st">"lgaliana"</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">path</span><span class="kw">:</span><span class="at"> </span><span class="st">"ensae-reproductibilite"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Dans <code>main.py</code>, importer ce fichier et remplacer la ligne précédemment évoquée par les valeurs du fichier. Tester en faisant tourner <code>main.py</code> <!-----
https://github.com/linogaliana/ensae-reproductibilite-projet-1/commit/4a9d935223b6af366d4cf2a2a208d98a25407fc6
-----></p>
</section>
</section>
<section id="anaconda" class="level2">
<h2 class="anchored" data-anchor-id="anaconda">Etape 2 : créer un environnement conda à partir du fichier <code>environment.yml</code></h2>
<p>L’environnement <code>conda</code> créé avec <code>conda env export</code> (<a href="#conda-export">étape 6</a>) contient énormément de dépendances, dont de nombreuses qui ne nous sont pas nécessaires (il en serait de même avec <code>pip freeze</code>). Nous n’avons en effet besoin que des <em>packages</em> présents dans la section <code>import</code> de nos scripts et les dépendances nécessaires pour que ces <em>packages</em> soient fonctionnels.</p>
<p>Vous allez chercher à obtenir un <code>environment.yml</code> beaucoup plus parcimonieux que celui généré par <code>conda env export</code></p>
<p></p>
<p>{{% panel name=“Approche générale <span class="emoji" data-emoji="koala">🐨</span>” %}}</p>
<p>Le tableau récapitulatif présent dans la <a href="../portability/#aide-mémoire">partie portabilité</a> peut être utile dans cette partie. L’idée est de partir <em>from scratch</em> et figer l’environnement qui permet d’avoir une appli fonctionnelle.</p>
<ul>
<li><p>Créer un environnement vide avec <code>Python 3.10</code> <!---
conda create -n monenv python=3.10.0
----></p></li>
<li><p>Activer cet environnement</p></li>
<li><p>Installer en ligne de commande avec <code>pip</code> les packages nécessaires pour faire tourner votre code</p></li>
</ul>
<!---
pip install pandas PyYAML s3fs scikit-learn
---->
<ul>
<li><p>Faire un <code>pip freeze &gt; requirements.txt</code> ou <code>conda env export &gt; environment.yml</code> (privilégier la deuxième option)</p></li>
<li><p>Retirer la section <code>prefix</code> (si elle est présente) et changer la section <code>name</code> en <code>monenv</code></p></li>
</ul>
<p>{{% /panel %}}</p>
<p>{{% panel name=“Approche fainéante <span class="emoji" data-emoji="sloth">🦥</span>” %}}</p>
<p>Nous allons générer une version plus minimaliste grâce à l’utilitaire <a href="https://github.com/bndr/pipreqs"><code>pipreqs</code></a></p>
<ul>
<li>Installer <code>pipreqs</code> en <code>pip install</code></li>
<li>En ligne de commande, depuis la racine du projet, faire <code>pipreqs</code></li>
<li>Ouvrir le <code>requirements.txt</code> automatiquement généré. Il est beaucoup plus minimal que celui que vous obtiendriez avec <code>pip freeze</code> ou l’<code>environment.yml</code> obtenu à <a href="#conda-export">l’étape 6</a>.</li>
<li>Remplacer toute la section <code>dependencies</code> du <code>environment.yml</code> par le contenu du <code>requirements.txt</code> (<span class="emoji" data-emoji="warning">⚠️</span> ne pas oublier l’indentation et le tiret en début de ligne)</li>
<li><span class="emoji" data-emoji="warning">⚠️</span> Modifier le tiret à <code>scikit learn</code>. Il ne faut pas un <em>underscore</em> mais un tiret</li>
<li>Ajouter la version de python (par exemple <code>python=3.10.0</code>) au début de la section <code>dependencies</code></li>
<li>Retirer la section <code>prefix</code> du fichier <code>environment.yml</code> (si elle est présente) et changer le contenu de la section <code>name</code> en <code>monenv</code></li>
<li>Créer l’environnement (<a href="../portability/#aide-mémoire">voir le tableau récapitulatif dans la partie portabilité</a>)</li>
</ul>
<!----
conda env create -f environment.yml
------>
<p>{{% /panel %}}</p>
<p>{{% /panelset %}}</p>
<p>Maintenant, il reste à tester si tout fonctionne bien dans notre environnement plus minimaliste:</p>
<ul>
<li>Activer l’environnement</li>
<li>Tester votre script en ligne de commande</li>
<li>Faire un <code>commit</code> quand vous êtes contents</li>
</ul>
</section>
<section id="docker" class="level2">
<h2 class="anchored" data-anchor-id="docker">Etape 3: conteneuriser avec Docker <i class="fab fa-docker"></i></h2>
<section id="préliminaire" class="level3">
<h3 class="anchored" data-anchor-id="préliminaire">Préliminaire</h3>
<ul>
<li>Se rendre sur l’environnement bac à sable <a href="https://labs.play-with-docker.com">Play with Docker</a></li>
<li>Dans le terminal <code>Linux</code>, cloner votre dépôt <code>Github</code> <i class="fab fa-github"></i></li>
<li>Créer via la ligne de commande un fichier <code>Dockerfile</code>. Il y a plusieurs manières de procéder, en voici un exemple:</li>
</ul>
<pre class="shell"><code>echo "#Dockerfile pour reproduire mon super travail" &gt; Dockerfile</code></pre>
<ul>
<li>Ouvrir ce fichier via l’éditeur proposé par l’environnement bac à sable.</li>
</ul>
</section>
<section id="création-dun-premier-dockerfile" class="level3">
<h3 class="anchored" data-anchor-id="création-dun-premier-dockerfile">Création d’un premier Dockerfile</h3>
<ul>
<li><span class="emoji" data-emoji="one">1️⃣</span> Comme couche de départ, partir d’une image légère comme <code>ubuntu:20.04</code></li>
<li><span class="emoji" data-emoji="two">2️⃣</span> Dans une deuxième couche, faire un <code>apt get -y update</code> et installer <code>wget</code> qui va être nécessaire pour télécharger <code>Miniconda</code> depuis la ligne de commande</li>
<li><span class="emoji" data-emoji="three">3️⃣</span> Dans la troisième couche, nous allons installer <code>Miniconda</code> :
<ul>
<li>Télécharger la dernière version de <code>Miniconda</code> avec <code>wget</code> depuis l’url de téléchargement direct https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh</li>
<li>Installer <code>Miniconda</code> dans le chemin <code>/home/coder/local/bin/conda</code></li>
<li>Effacer le fichier d’installation pour libérer de la place sur l’image</li>
</ul></li>
<li><span class="emoji" data-emoji="four">4️⃣</span> En quatrième couche, on va installer <code>mamba</code> pour accélérer l’installation des packages dans notre environnement.</li>
<li><span class="emoji" data-emoji="five">5️⃣</span> En cinquième couche, nous allons créer l’environnement <code>conda</code>:
<ul>
<li>Utiliser <code>COPY</code> pour que <code>Docker</code> soit en mesure d’utiliser le fichier <code>environment.yml</code> (sinon <code>Docker</code> renverra une erreur)</li>
<li>Créer l’environnement vide <code>monenv</code> (présentant uniquement <code>Python</code> 3.10) avec la commande <code>conda</code> adéquate</li>
<li>Mettre à jour l’environnement en utilisant <code>environment.yml</code> avec <code>mamba</code></li>
</ul></li>
<li><span class="emoji" data-emoji="six">6️⃣</span> Utiliser <code>ENV</code> pour ajouter l’environnement <code>monenv</code> au <code>PATH</code> et utiliser le <em>fix</em> suivant:</li>
</ul>
<div class="sourceCode" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>RUN echo <span class="st">"export PATH=$PATH"</span> <span class="op">&gt;&gt;</span> <span class="op">/</span>home<span class="op">/</span>coder<span class="op">/</span>.bashrc  <span class="co"># Temporary fix while PATH gets overwritten by code-server</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><span class="emoji" data-emoji="seven">7️⃣</span> Exposer sur le port <code>5000</code></li>
<li><span class="emoji" data-emoji="eight">8️⃣</span> En dernière étape, utiliser <code>CMD</code> pour reproduire le comportement de <code>python main.py</code></li>
</ul>
<p>{{% box status=“hint” title=“Hint: <code>mamba</code>” icon=“fa fa-lightbulb” %}} <code>mamba</code> est une alternative à <code>conda</code> pour installer des <em>packages</em> dans un environnement <code>Miniconda</code>/<code>Anaconda</code>. <code>mamba</code> n’est pas obligatoire, <code>conda</code> peut suffire. Cependant, <code>mamba</code> est beaucoup plus rapide que <code>conda</code> pour installer des packages à installer ; il s’agit donc d’un utilitaire très pratique. {{% /box %}}</p>
<p></p>
<p>{{% panel name=“Indications supplémentaires” %}}</p>
<p>Cliquer sur les onglets ci-dessus <span class="emoji" data-emoji="point_up_2">👆</span> pour bénéficier d’indications supplémentaires, pour vous aider. Cependant, essayez de ne pas les consulter immédiatement: n’hésitez pas à tâtonner.</p>
<p>{{% /panel %}}</p>
<p>{{% panel name=“Installation de Miniconda” %}}</p>
<pre class="shell"><code># INSTALL MINICONDA -------------------------------
ARG CONDA_DIR=/home/coder/local/bin/conda
RUN wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
RUN bash Miniconda3-latest-Linux-x86_64.sh -b -p $CONDA_DIR
RUN rm -f Miniconda3-latest-Linux-x86_64.sh</code></pre>
<p>{{% /panel %}}</p>
<p>{{% panel name=“Installation de mamba” %}}</p>
<pre class="shell"><code>ENV PATH="/home/coder/local/bin/conda/bin:${PATH}"
RUN conda install mamba -n base -c conda-forge</code></pre>
<p>{{% /panel %}}</p>
<p>{{% panel name=“Création de l’environnement” %}}</p>
<pre class="shell"><code>COPY environment.yml .
RUN conda create -n monenv python=3.10
RUN mamba env update -n monenv -f environment.yml</code></pre>
<p>{{% /panel %}}</p>
<p></p>
</section>
<section id="construire-limage" class="level3">
<h3 class="anchored" data-anchor-id="construire-limage">Construire l’image</h3>
<p>Maintenant, nous avons défini notre recette. Il nous reste à faire notre plat et à le goûter</p>
<ul>
<li>Utiliser <code>docker build</code> pour créer une image avec le tag <code>my-python-app</code></li>
<li>Vérifier les images dont vous disposez. Vous devriez avoir un résultat proche de celui-ci</li>
</ul>
<!---
docker build . -t my-python-app
docker images
---->
<pre class="shell"><code>REPOSITORY      TAG       IMAGE ID       CREATED         SIZE
my-python-app   latest    c0dfa42d8520   6 minutes ago   2.23GB
ubuntu          20.04     825d55fb6340   6 days ago      72.8MB</code></pre>
</section>
<section id="tester-limage-découverte-du-cache" class="level3">
<h3 class="anchored" data-anchor-id="tester-limage-découverte-du-cache">Tester l’image: découverte du cache</h3>
<p>Il ne reste plus qu’à goûter la recette et voir si le plat est bon.</p>
<p>Utiliser <code>docker run</code> avec l’option <code>it</code> pour pouvoir appeler l’image depuis son tag</p>
<!----
docker run -it my-python-app
---->
<p><span class="emoji" data-emoji="warning">⚠️</span> <span class="emoji" data-emoji="bomb">💣</span> <span class="emoji" data-emoji="fire">🔥</span> <code>Docker</code> ne sait pas où trouver le fichier <code>main.py</code>. D’ailleurs, il ne connait pas d’autres fichiers de notre application qui sont nécessaires pour faire tourner le code: <code>config.yaml</code> et le dossier <code>src</code></p>
<ul>
<li><p>Avant l’étape <code>EXPOSE</code> utiliser plusieurs <code>ADD</code> et/ou <code>COPY</code> pour que l’application dispose de tous les éléments minimaux pour être en mesure de fonctionner</p></li>
<li><p>Refaire tourner <code>docker run</code> <!---
docker run -it my-python-app
---></p></li>
</ul>
<p>{{% box status=“tip” title=“Note” icon=“fa fa-hint” %}} Ici, le <em>cache</em> permet d’économiser beaucoup de temps. Par besoin de refaire tourner toutes les étapes, <code>Docker</code> agit de manière intelligente en faisant tourner uniquement les nouvelles étapes. {{% /box %}}</p>
</section>
<section id="corriger-une-faille-de-reproductibilité" class="level3">
<h3 class="anchored" data-anchor-id="corriger-une-faille-de-reproductibilité">Corriger une faille de reproductibilité</h3>
<p>Vous devriez rencontrer une erreur liée à la variable d’environnement <code>AWS_ENDPOINT_URL</code>. C’est normal, elle est inconnue de cet environnement minimaliste. D’ailleurs, <code>Docker</code> n’a aucune raison de connaître votre espace de stockage sur le <code>S3</code> du <code>SSP-Cloud</code> si vous ne lui dites pas. Donc cet environnement ne sait pas comment accéder aux fichiers présents dans votre <code>minio</code>.</p>
<p>Vous allez régler ce problème avec les étapes suivantes, :</p>
<ul>
<li><span class="emoji" data-emoji="one">1️⃣</span> Naviguer dans l’<a href="https://datalab.sspcloud.fr/mes-fichiers">interface du SSP-Cloud</a> pour retrouver les liens d’accès direct de vos fichiers</li>
<li><span class="emoji" data-emoji="two">2️⃣</span> Dans <code>VSCode</code>, les mettre dans <code>config.yaml</code> (faire de nouvelles clés)</li>
<li><span class="emoji" data-emoji="three">3️⃣</span> Dans <code>VSCode</code>, modifier la fonction d’import pour s’adapter à ce changement.</li>
<li><span class="emoji" data-emoji="four">4️⃣</span> Faire un <code>commit</code> et pusher les fichiers</li>
<li><span class="emoji" data-emoji="five">5️⃣</span> Dans l’environnement bac à sable, faire un <code>pull</code> pour récupérer ces modifications</li>
<li><span class="emoji" data-emoji="six">6️⃣</span> Tester à nouveau le <code>build</code> (là encore le <em>cache</em> est bien pratique !)</li>
</ul>
<!---
cf. 
https://github.com/linogaliana/ensae-reproductibilite-projet-1/commit/56946b4c5cb860d50b908d98a87fb549624314a6
----->
<p><span class="emoji" data-emoji="tada">🎉</span> A ce stade, la matrice de confusion doit fonctionner. Vous avez créé votre première application reproductible !</p>
</section>
</section>
</section>
<section id="partie-3-mise-en-production" class="level1">
<h1>Partie 3 : mise en production</h1>
<p>Une image <code>Docker</code> est un livrable qui n’est pas forcément intéressant pour tous les publics. Certains préféreront avoir un plat bien préparé qu’une recette. Nous allons donc proposer d’aller plus loin en proposant plusieurs types de livrables. Cela va nous amener à découvrir les outils du CI/CD (<em>Continuous Integration / Continuous Delivery</em>) qui sont au coeur de l’approche <code>DevOps</code>. Notre approche appliquée au <em>machine learning</em> va nous entraîner plutôt du côté du <code>MLOps</code> qui devient une approche de plus en plus fréquente dans l’industrie de la <em>data science</em>.</p>
<p>Nous allons améliorer notre approche de trois manières:</p>
<ul>
<li>Automatisation de la création de l’image <code>Docker</code> et tests automatisés de la qualité du code ;</li>
<li>Production d’un site <em>web</em> automatisé permettant de documenter et valoriser le modèle de <em>Machine Learning</em> ;</li>
<li>Mise à disposition du modèle entraîné par le biais d’une API pour ne pas le ré-entraîner à chaque fois et faciliter sa réutilisation ;</li>
</ul>
<p>A chaque fois, nous allons d’abord tester en local notre travail puis essayer d’automatiser cela avec les outils de <code>Github</code>.</p>
<p>On va ici utiliser l’intégration continue pour deux objectifs distincts:</p>
<ul>
<li>la mise à disposition de l’image <code>Docker</code> ;</li>
<li>la mise en place de tests automatisés de la qualité du code sur le modèle de notre <code>linter</code> précédent</li>
</ul>
<p>Nous allons utiliser <code>Github Actions</code> pour cela.</p>
<section id="etape-préliminaire" class="level2">
<h2 class="anchored" data-anchor-id="etape-préliminaire">Etape préliminaire</h2>
<p>Pour ne pas risquer de tout casser sur notre branche <code>master</code>, nous allons nous placer sur une branche nommée <code>dev</code>:</p>
<ul>
<li>si dans l’étape suivante vous appliquez la méthode la plus simple, vous allez pouvoir la créer depuis l’interface de <code>Github</code> ;</li>
<li>si vous utilisez l’autre méthode, vous allez devoir la créer en local ( via la commande <code>git checkout -b dev</code>)</li>
</ul>
</section>
<section id="etape-1-mise-en-place-de-tests-automatisés" class="level2">
<h2 class="anchored" data-anchor-id="etape-1-mise-en-place-de-tests-automatisés">Etape 1: mise en place de tests automatisés</h2>
<p>Avant d’essayer de mettre en oeuvre la création de notre image <code>Docker</code> de manière automatisée, nous allons présenter la logique de l’intégration continue en généralisant les évaluations de qualité du code avec le <code>linter</code></p>
<p></p>
<p>{{% panel name=“Utilisation d’un <em>template</em> <code>Github</code> <span class="emoji" data-emoji="cat">🐱</span>” %}}</p>
<p><strong>Methode la plus simple: utilisation d’un <em>template</em> Github</strong></p>
<p>Si vous cliquez sur l’onglet <code>Actions</code> de votre dépôt, <code>Github</code> vous propose des <em>workflows</em> standardisés reliés à <code>Python</code>. Choisir l’option <code>Python Package using Anaconda</code>.</p>
<p>warning: Nous n’allons modifier que deux éléments de ce fichier.</p>
<p><span class="emoji" data-emoji="one">1️⃣</span> La dernière étape (<code>Test with pytest</code>) ne nous est pas nécessaire car nous n’avons pas de tests unitaires Nous allons donc remplacer celle-ci par l’utilisation de <code>pylint</code> pour avoir une note de qualité du package.</p>
<ul>
<li>Utiliser <code>pylint</code> à cette étape pour noter les scripts ;</li>
<li>Vous pouvez fixer un score minimal à 5 (option <code>--fail-under=5</code>)</li>
</ul>
<p><span class="emoji" data-emoji="two">2️⃣</span> Mettre entre guillements la version de <code>Python</code> pour que celle-ci soit reconnue.</p>
<p><span class="emoji" data-emoji="three">3️⃣</span> Enfin, finaliser la création de ce script:</p>
<ul>
<li>En cliquant sur le bouton <code>Start Commit</code>, choisir la méthode <code>Create a new branch for this commit and start a pull request</code> en nommant la branche <code>dev</code></li>
<li>Créer la <code>Pull Request</code> en lui donnant un nom signifiant</li>
</ul>
<p>{{% /panel %}}</p>
<p>{{% panel name=“Méthode manuelle” %}}</p>
<p><span class="emoji" data-emoji="warning">⚠️</span> On est plutôt sur une méthode de galérien. Il vaut mieux privilégier l’autre approche</p>
<p>On va éditer depuis <code>VisualStudio</code> nos fichiers.</p>
<ul>
<li>Créer une branche <code>dev</code> en ligne de commande</li>
<li>Créer un dossier <code>.github/workflows</code> via la ligne de commande ou l’explorateur de fichier <!---mkdir .github/workflows -p ----></li>
<li>Créer un fichier <code>.github/workflows/quality.yml</code>.</li>
</ul>
<p>Nous allons construire, par étape, une version simplifiée du <code>Dockerfile</code> présent dans <a href="https://medium.com/swlh/enhancing-code-quality-with-github-actions-67561c6f7063">ce post</a> et dans <a href="https://autobencoder.com/2020-08-24-conda-actions/">celui-ci</a></p>
<p><span class="emoji" data-emoji="one">1️⃣</span> D’abord, définissons des paramètres pour indiquer à <code>Github</code> quand faire tourner notre script:</p>
<ul>
<li>Commencez par nommer votre <em>workflow</em> par exemple <code>Python Linting</code> avec la clé <code>name</code></li>
<li>Nous allons faire tourner ce <em>workflow</em> dans la branche <code>master</code> et dans la branche actuelle (<code>dev</code>). Ici, nous laissons de côté les autres éléments (par exemple le fait de faire tourner à chaque <em>pull request</em>). La clé <code>on</code> est dédiée à cet usage</li>
</ul>
<p><span class="emoji" data-emoji="two">2️⃣</span> Ensuite, défnissons le contexte d’exécution des tâches (<code>jobs</code>) de notre script dans les options de la partie <code>build</code>:</p>
<ul>
<li>Utilisons une machine <code>ubuntu-latest</code>. Nous verrons plus tard comment améliorer cela.</li>
</ul>
<p><span class="emoji" data-emoji="three">3️⃣</span> Nous allons ensuite mélanger des étapes pré-définies (des actions du <em>marketplace</em>) et des instructions que nous faisons :</p>
<ul>
<li>Le <em>runner</em> <code>Github</code> doit récupérer le contenu de notre dépôt, pour cela utiliser l’action <code>checkout</code>. Par rapport à l’exemple, il convient d’ajouter, pour le moment, un paramètre <code>ref</code> avec le nom de la branche (par exemple <code>dev</code>)</li>
<li><del>On installe ensuite <code>Python</code> avec l’action <code>setup-python</code></del> Pas besoin d’installer <code>Python</code>, on va utiliser l’option <code>conda-incubator/setup-miniconda@v2</code></li>
<li>Pour installer <code>Python</code> et l’environnement <code>conda</code>, on va plutôt utiliser l’astuce de <a href="https://autobencoder.com/2020-08-24-conda-actions/">ce blog</a> avec l’option <code>conda-incubator/setup-miniconda@v2</code></li>
<li>On utilise ensuite <code>flake8</code> et <code>pylint</code> (option <code>--fail-under=5</code>) pour effectuer des diagnostics de qualité</li>
</ul>
<p>Il ne reste plus qu’à faire un <code>commit</code> et espérer que cela fonctionne. Cela devrait donner le fichier suivant :</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Python Linting</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">push</span><span class="kw">:</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">branches</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">master</span><span class="kw">,</span><span class="at"> dev</span><span class="kw">]</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest    </span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v3</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">ref</span><span class="kw">:</span><span class="at"> </span><span class="st">"dev"</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> conda-incubator/setup-miniconda@v2</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">activate-environment</span><span class="kw">:</span><span class="at"> monenv</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">environment-file</span><span class="kw">:</span><span class="at"> environment.yml</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">python-version</span><span class="kw">:</span><span class="at"> </span><span class="st">'3.10'</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">auto-activate-base</span><span class="kw">:</span><span class="at"> </span><span class="ch">false</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">shell</span><span class="kw">:</span><span class="at"> bash -l {0}</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>          conda info</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>          conda list</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Lint with flake8</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>          pip install flake8</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>          flake8 src --count --select=E9,F63,F7,F82 --show-source --statistics</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>          flake8 src --count --max-complexity=10 --max-line-length=79 --statistics</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Lint with Pylint</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>          pip install pylint</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>          pylint src</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>{{% /panel %}}</p>
<p></p>
<p>Maintenant, nous pouvons observer que l’onglet <code>Actions</code> s’est enrichi. Chaque <code>commit</code> va entraîner une action pour tester nos scripts.</p>
<p>Si la note est mauvaise, nous aurons une croix rouge (et nous recevrons un mail). On pourra ainsi détecter, en développant son projet, les moments où on dégrade la qualité du script afin de la rétablir immédiatemment.</p>
<p>{{% box status=“hint” title=“Un <code>linter</code> sous forme de <em>hook</em> pre-commit” icon=“fa fa-lightbulb” %}}</p>
<p><code>Git</code> offre une fonctionalité intéressante lorsqu’on est puriste: les <em>hooks</em>. Il s’agit de règles qui doivent être satisfaites pour que le fichier puisse être committé. Cela assurera que chaque <code>commit</code> remplisse des critères de qualité afin d’éviter le problème de la procrastination.</p>
<p>La <a href="https://pylint.pycqa.org/en/latest/user_guide/pre-commit-integration.html">documentation de pylint</a> offre des explications supplémentaires.</p>
<p>{{% /box %}}</p>
</section>
<section id="etape-2-automatisation-de-la-livraison-de-limage-docker" class="level2">
<h2 class="anchored" data-anchor-id="etape-2-automatisation-de-la-livraison-de-limage-docker">Etape 2: Automatisation de la livraison de l’image <code>Docker</code></h2>
<p>Maintenant, nous allons automatiser la mise à disposition de notre image sur <code>DockerHub</code>. Cela facilitera sa réutilisation mais aussi des valorisations ultérieures.</p>
<p>Là encore, nous allons utiliser une série d’actions pré-configurées.</p>
<p><span class="emoji" data-emoji="one">1️⃣</span> Pour que <code>Github</code> puisse s’authentifier auprès de <code>DockerHub</code>, il va falloir d’abord interfacer les deux plateformes. Pour cela, nous allons utiliser un jeton (<em>token</em>) <code>DockerHub</code> que nous allons mettre dans un espace sécurisé associé à votre dépôt <code>Github</code>. Cette démarche sera là même ultérieurement lorsque nous connecterons notre dépôt à un autre service tiers, à savoir <code>Netlify</code>:</p>
<ul>
<li>Se rendre sur https://hub.docker.com/ et créer un compte.</li>
<li>Aller dans les paramètres (https://hub.docker.com/settings/general) et cliquer, à gauche, sur <code>Security</code></li>
<li>Créer un jeton personnel d’accès, ne fermez pas l’onglet en question, vous ne pouvez voir sa valeur qu’une fois.</li>
<li>Dans votre dépôt <code>Github</code>, cliquer sur l’onglet <code>Settings</code> et cliquer, à gauche, sur <code>Actions</code>. Sur la page qui s’affiche, cliquer sur <code>New repository secret</code></li>
<li>Donner le nom <code>DOCKERHUB_TOKEN</code> à ce jeton et copier la valeur. Valider</li>
<li>Créer un deuxième secret nommé <code>DOCKERHUB_USERNAME</code> ayant comme valeur le nom d’utilisateur que vous avez créé sur <code>Dockerhub</code></li>
</ul>
<p><span class="emoji" data-emoji="two">2️⃣</span> A ce stade, nous avons donné les moyens à <code>Github</code> de s’authentifier avec notre identité sur <code>Dockerhub</code>. Il nous reste à mettre en oeuvre l’action en s’inspirant de https://github.com/docker/build-push-action/#usage. On ne va modifier que trois éléments dans ce fichier. Effectuer les actions suivantes:</p>
<ul>
<li>Créer depuis <code>VSCode</code> un fichier <code>.github/workflows/docker.yml</code> et coller le contenu du <em>template</em> dedans ;</li>
<li>Changer le nom en un titre plus signifiant (par exemple <em>“Production de l’image Docker”</em>)</li>
<li>Ajouter <code>master</code> et <code>dev</code> à la liste des branches sur lesquelles tourne le pipeline ;</li>
<li>Changer le tag à la fin pour mettre <code>&lt;username&gt;/ensae-repro-docker:latest</code> où <code>username</code> est le nom d’utilisateur sur <code>DockerHub</code>;</li>
<li>Faire un <code>commit</code> et un <code>push</code> de ces fichiers</li>
</ul>
<p><span class="emoji" data-emoji="four">4️⃣</span> Comme on est fier de notre travail, on va afficher ça avec un badge sur le <code>README</code>. Pour cela, on se rend dans l’onglet <code>Actions</code> et on clique sur un des scripts en train de tourner.</p>
<ul>
<li>En haut à droite, on clique sur <code>...</code></li>
<li>Sélectionner <code>Create status badge</code></li>
<li>Récupérer le code <code>Markdown</code> proposé</li>
<li>Copier dans le <code>README</code> depuis <code>VSCode</code></li>
<li>Faire de même pour l’autre <em>workflow</em></li>
</ul>
<p><span class="emoji" data-emoji="five">5️⃣</span> Maintenant, il nous reste à tester notre application dans l’espace bac à sable:</p>
<ul>
<li>Se rendre sur l’environnement bac à sable</li>
<li>Créer un fichier <code>Dockerfile</code> ne contenant que l’import et le déploiement de l’appli:</li>
</ul>
<div class="sourceCode" id="cb30"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="at">FROM &lt;username&gt;/ensae-repro-docker:latest</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="at">EXPOSE 5000</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="at">CMD ["python", "main.py"]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Comme précédemment, faire un <em>build</em></li>
<li>Tester l’image avec <code>run</code></li>
</ul>
<p><span class="emoji" data-emoji="tada">🎉</span> La matrice de confusion doit s’afficher ! Vous avez grandement facilité la réutilisation de votre image.</p>
</section>
<section id="etape-3-création-dun-rapport-automatique" class="level2">
<h2 class="anchored" data-anchor-id="etape-3-création-dun-rapport-automatique">Etape 3: création d’un rapport automatique</h2>
<p>Maintenant, nous allons créer et déployer un site web pour valoriser notre travail. Cela va impliquer trois étapes:</p>
<ul>
<li>Tester en local le logiciel <code>quarto</code> et créer un rapport minimal qui sera compilé par <code>quarto</code> ;</li>
<li>Enrichir l’image docker avec le logiciel <code>quarto</code> ;</li>
<li>Compiler le document en utilisant cette image sur les serveurs de <code>Github</code> ;</li>
<li>Déployer ce rapport minimal pour le rendre disponible à tous sur le <em>web</em>.</li>
</ul>
<p>Le but est de proposer un rapport minimal qui illustre la performance du modèle est la <em>feature importance</em>. Pour ce dernier élément, le rapport qui sera proposé utilise <code>shap</code> qui est une librairie dédiée à l’interprétabilité des modèles de <em>machine learning</em></p>
<section id="rapport-minimal-en-local" class="level3">
<h3 class="anchored" data-anchor-id="rapport-minimal-en-local">1. Rapport minimal en local</h3>
<p><span class="emoji" data-emoji="one">1️⃣</span> La première étape consiste à installer <code>quarto</code> sur notre machine <code>Linux</code> sur laquelle tourne <code>VSCode</code>:</p>
<ul>
<li>Dans un terminal, installer <code>quarto</code> avec les commandes suivantes:</li>
</ul>
<pre class="shell"><code>QUARTO_VERSION="0.9.287"
wget "https://github.com/quarto-dev/quarto-cli/releases/download/v${QUARTO_VERSION}/quarto-${QUARTO_VERSION}-linux-amd64.deb"
sudo apt install "./quarto-${QUARTO_VERSION}-linux-amd64.deb"</code></pre>
<ul>
<li>S’assurer qu’on travaille bien depuis l’environnement <code>conda</code> <code>monenv</code>. Sinon l’activer</li>
</ul>
<p><span class="emoji" data-emoji="two">2️⃣</span> Il va être nécessaire d’enrichir l’environnement <code>conda</code>. Certaines dépendances sont nécessaires pour que <code>quarto</code> fonctionne bien avec <code>Python</code> (<code>jupyter</code>, <code>nbclient</code>…) alors que d’autres ne sont nécessaires que parce qu’ils sont utilisés dans le document (<code>seaborn</code>, <code>shap</code>…). Changer la section <code>dependencies</code> avec la liste suivante:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dependencies</span><span class="kw">:</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> python=3.10.0</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> ipykernel==6.13.0</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> jupyter==1.0.0</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> matplotlib==3.5.1</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> nbconvert==6.5.0</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> nbclient==0.6.0</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> nbformat==5.3.0</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> pandas==1.4.1</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> PyYAML==6.0</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> s3fs==2022.2.0</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> scikit-learn==1.0.2</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> seaborn==0.11.2</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> shap==0.40.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<table class="table">
<caption>three: Créer un fichier nommé <code>report.qmd</code></caption>
<thead>
<tr class="header">
<th>~markdown</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>title: “Comprendre les facteurs de survie sur le Titanic”</td>
</tr>
<tr class="even">
<td>subtitle: “Un rapport innovant”</td>
</tr>
<tr class="odd">
<td>format:</td>
</tr>
<tr class="even">
<td>html:</td>
</tr>
<tr class="odd">
<td>self-contained: true</td>
</tr>
<tr class="even">
<td>ipynb: default</td>
</tr>
<tr class="odd">
<td>jupyter: python3</td>
</tr>
</tbody>
</table>
<p>Voici un rapport présentant quelques intuitions issues d’un modèle <em>random forest</em> sur le jeu de données <code>Titanic</code> entraîné et déployé de manière automatique.</p>
<p>Il est possible de télécharger cette page sous format <code>Jupyter Notebook</code> <a href="report.ipynb" download="">ici</a></p>
<div class="sourceCode" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> main</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> main.X_train</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> main.y_train</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>training_data <span class="op">=</span> main.training_data</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>rdmf <span class="op">=</span> RandomForestClassifier(n_estimators<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>rdmf.fit(X_train, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
</section>
<section id="feature-importance" class="level1">
<h1>Feature importance</h1>
<p>La <strong>?@fig-feature-importance</strong> représente l’importance des variables :</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>feature_imp <span class="op">=</span> pd.Series(rdmf.feature_importances_, index<span class="op">=</span>training_data.iloc[:,<span class="dv">1</span>:].columns).sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-feature-importance</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Feature importance"</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">6</span>))</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>sns.barplot(x<span class="op">=</span>feature_imp, y<span class="op">=</span>feature_imp.index)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Add labels to your graph</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Feature Importance Score'</span>)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Features'</span>)</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Visualizing Important Features"</span>)</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Celle-ci peut également être obtenue grâce à la librairie <code>shap</code>:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo : true</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shap</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>shap_values <span class="op">=</span> shap.TreeExplainer(rdmf).shap_values(X_train)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>shap.summary_plot(shap_values, X_train, plot_type<span class="op">=</span><span class="st">"bar"</span>, feature_names <span class="op">=</span> training_data.iloc[:,<span class="dv">1</span>:].columns)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>On peut également utiliser cette librairie pour interpréter la prédiction de notre modèle:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># explain all the predictions in the test set</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>explainer <span class="op">=</span> shap.TreeExplainer(rdmf)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate Shap values</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>choosen_instance <span class="op">=</span> main.X_test[<span class="dv">15</span>]</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>shap_values <span class="op">=</span> explainer.shap_values(choosen_instance)</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>shap.initjs()</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>shap.force_plot(explainer.expected_value[<span class="dv">1</span>], shap_values[<span class="dv">1</span>], choosen_instance, feature_names <span class="op">=</span> training_data.iloc[:,<span class="dv">1</span>:].columns)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="qualité-prédictive-du-modèle" class="level1">
<h1>Qualité prédictive du modèle</h1>
<p>La matrice de confusion est présentée sur la <strong>?@fig-confusion</strong></p>
<div class="sourceCode" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-confusion</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Matrice de confusion"</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> confusion_matrix</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>conf_matrix <span class="op">=</span> confusion_matrix(main.y_test, rdmf.predict(main.X_test))</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">5</span>))</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>sns.heatmap(conf_matrix, annot<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Confusion Matrix'</span>)</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Ou, sous forme de tableau:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(conf_matrix, columns<span class="op">=</span>[<span class="st">'Predicted'</span>,<span class="st">'Observed'</span>], index <span class="op">=</span> [<span class="st">'Predicted'</span>,<span class="st">'Observed'</span>]).to_html()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>~~~</p>
<p><span class="emoji" data-emoji="four">4️⃣</span> On va tenter de compiler ce document</p>
<ul>
<li><p>Le compiler en local avec la commande <code>quarto render report.qmd</code></p></li>
<li><p>Vous devriez rencontrer l’erreur suivante:</p></li>
</ul>
<div class="sourceCode" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="op">---------------------------------------------------------------------------</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="pp">AttributeError</span>                            Traceback (most recent call last)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>Input In [<span class="dv">1</span>], <span class="kw">in</span> <span class="op">&lt;</span>cell line: <span class="dv">6</span><span class="op">&gt;</span>()</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>      <span class="dv">4</span> <span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>      <span class="dv">5</span> <span class="im">import</span> main</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="op">----&gt;</span> <span class="dv">6</span> X_train <span class="op">=</span> main.X_train</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>      <span class="dv">7</span> y_train <span class="op">=</span> main.y_train</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>      <span class="dv">8</span> training_data <span class="op">=</span> main.training_data</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="pp">AttributeError</span>: module <span class="st">'main'</span> has no attribute <span class="st">'X_train'</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="pp">AttributeError</span>: module <span class="st">'main'</span> has no attribute <span class="st">'X_train'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p>Refactoriser <code>main.py</code> pour que toutes les opérations, à l’exception du print de la matrice de confusion ne soient plus dans la section <code>__main__</code> afin qu’ils soient systématiquement exécutés.</p></li>
<li><p>Tenter à nouveau <code>quarto render report.qmd</code></p></li>
<li><p>Deux fichiers ont été générés:</p>
<ul>
<li>un <code>Notebook</code> que vous pouvez ouvrir et dont vous pouvez exécuter des cellules</li>
<li>un fichier <code>HTML</code> que vous pouvez télécharger et ouvrir</li>
</ul></li>
</ul>
<p><span class="emoji" data-emoji="five">5️⃣</span> On a déjà un résultat assez esthétique en ce qui concerne la page <code>HTML</code>. Cependant, on peut se dire que certains paramètres par défaut, comme l’affichage des blocs de code, ne conviennent pas au public ciblé. De même, certains paramètres de style, comme l’affichage des tableaux peuvent ne pas convenir à notre charte graphique. On va remédier à cela en deux étapes:</p>
<ul>
<li>enrichir le <em>header</em> d’options globales contrôlant le comportement de <code>quarto</code></li>
<li>créer un fichier <code>CSS</code> pour avoir de beaux tableaux</li>
</ul>
<p><span class="emoji" data-emoji="six">6️⃣</span> Changer la section <code>format</code> du <em>header</em> avec les options suivantes:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">format</span><span class="kw">:</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">html</span><span class="kw">:</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">echo</span><span class="kw">:</span><span class="at"> </span><span class="ch">false</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">code-fold</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">self-contained</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">code-summary</span><span class="kw">:</span><span class="at"> </span><span class="st">"Show the code"</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">warning</span><span class="kw">:</span><span class="at"> </span><span class="ch">false</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">message</span><span class="kw">:</span><span class="at"> </span><span class="ch">false</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">theme</span><span class="kw">:</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> cosmo</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> css/custom.scss</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ipynb</span><span class="kw">:</span><span class="at"> default</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><span class="emoji" data-emoji="seven">7️⃣</span> Créer le fichier <code>css/custom.scss</code> avec le contenu suivant:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode css code-with-copy"><code class="sourceCode css"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*-- scss:rules --*/</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>table {</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">border-collapse</span>: <span class="dv">collapse</span><span class="op">;</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">margin</span>: <span class="dv">25</span><span class="dt">px</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">font-size</span>: <span class="dv">0.9</span><span class="dt">em</span><span class="op">;</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">font-family</span>: <span class="dv">sans-serif</span><span class="op">;</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">min-width</span>: <span class="dv">400</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">box-shadow</span>: <span class="dv">0</span> <span class="dv">0</span> <span class="dv">20</span><span class="dt">px</span> <span class="fu">rgba(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0.15</span><span class="fu">)</span><span class="op">;</span>  </span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>thead tr {</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">background-color</span>: <span class="cn">#516db0</span><span class="op">;</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">color</span>: <span class="cn">#ffffff</span><span class="op">;</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">text-align</span>: <span class="dv">center</span><span class="op">;</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>th<span class="op">,</span> td {</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">padding</span>: <span class="dv">12</span><span class="dt">px</span> <span class="dv">15</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>tbody tr {</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">border-bottom</span>: <span class="dv">1</span><span class="dt">px</span> <span class="dv">solid</span> <span class="cn">#dddddd</span><span class="op">;</span></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>tbody tr<span class="in">:nth-of-type(even)</span> {</span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">background-color</span>: <span class="cn">#f3f3f3</span><span class="op">;</span></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>tbody tr<span class="in">:last-of-type</span> {</span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">border-bottom</span>: <span class="dv">2</span><span class="dt">px</span> <span class="dv">solid</span> <span class="cn">#516db0</span><span class="op">;</span></span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a>tbody tr<span class="fu">.active-row</span> {</span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">font-weight</span>: <span class="dv">bold</span><span class="op">;</span></span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">color</span>: <span class="cn">#009879</span><span class="op">;</span></span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><span class="emoji" data-emoji="eight">8️⃣</span> Compiler à nouveau et observer le changement d’esthétique du <code>HTML</code></p>
<p><span class="emoji" data-emoji="nine">9️⃣</span> Commit des nouveaux fichier <code>report.qmd</code>, <code>custom.scss</code> et des fichiers déjà existants.</p>
<p>{{% box status=“hint” title=“Un <code>linter</code> sous forme de <em>hook</em> pre-commit” icon=“fa fa-lightbulb” %}}</p>
<p>On ne <code>commit</code> pas les <em>output</em>, ici le notebook et le fichier html. Les mettre sur le dépôt <code>Github</code> n’est pas la bonne manière de les mettre à disposition. On va le voir, on va utiliser l’approche CI/CD pour cela.</p>
<p>Idéalement, on ajoute au <code>.gitignore</code> les fichiers concernés, ici <code>report.ipynb</code> et <code>report.html</code></p>
<p>{{% /box %}}</p>
<section id="enrichir-limage-docker" class="level3">
<h3 class="anchored" data-anchor-id="enrichir-limage-docker">3. Enrichir l’image <code>Docker</code></h3>
<p>On va vouloir mettre à jour notre image pour automatiser, à terme, la production de nos livrables (le notebook et la page web).</p>
<p>Pour cela, il est nécessaire que notre image intègre le logiciel <code>quarto</code>.</p>
<p><span class="emoji" data-emoji="one">1️⃣</span> A partir du script précédent d’installation de <code>quarto</code>, enrichir l’image <code>Docker</code><a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a></p>
<!----
ENV QUARTO_VERSION="0.9.287"
RUN wget "https://github.com/quarto-dev/quarto-cli/releases/download/v${QUARTO_VERSION}/quarto-${QUARTO_VERSION}-linux-amd64.deb"
RUN apt install "./quarto-${QUARTO_VERSION}-linux-amd64.deb"
----->
</section>
<section id="automatisation-avec-github-actions" class="level3">
<h3 class="anchored" data-anchor-id="automatisation-avec-github-actions">4. Automatisation avec <code>Github Actions</code></h3>
<p><span class="emoji" data-emoji="one">1️⃣</span> Créer un nouveau fichier <code>.github/workflows.report.yml</code></p>
<p>Si les dépendances et l’image ont bien été enrichis, cette étape est quasi directe avec</p>
<p></p>
<p>{{% panel name=“Version autonome <span class="emoji" data-emoji="car">🚗</span>” %}}</p>
<ul>
<li>Donner comme nom <code>Deploy as website</code></li>
<li>Effectuer cette action à chaque <code>push</code> sur les branches <code>main</code>, <code>master</code> et <code>dev</code></li>
<li>Le job doit tourner sur une machine <code>ubuntu</code></li>
<li>Cependant, il convient d’utiliser comme <code>container</code> votre image Docker</li>
<li>Les <code>steps</code>:
<ul>
<li>Récupérer le contenu du dossier avec <code>checkout</code></li>
<li>Faire un <code>quarto render</code></li>
<li>Récupérer le notebook sous forme d’artefact</li>
</ul></li>
</ul>
<p>{{% /panel %}}</p>
<p>{{% panel name=“Version guidée :map:” %}}</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Deploy as website</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">push</span><span class="kw">:</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">branches</span><span class="kw">:</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> main</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> master</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> dev</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">container</span><span class="kw">:</span><span class="at"> linogaliana/ensae-repro-docker:latest</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v3</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Render site</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> quarto render report.qmd</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/upload-artifact@v1</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Report</span></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">path</span><span class="kw">:</span><span class="at"> report.ipynb</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>{{% /panel %}}</p>
<p></p>
<p>Si vous êtes fier de vous, vous pouvez ajouter le badge de ce workflow sur le <code>README</code> <span class="emoji" data-emoji="sunglasses">😎</span></p>
<p>Cette étape nous a permis d’automatiser la construction de nos livrables. Mais la mise à disposition de ce livrable est encore assez manuelle: il faut aller chercher à la main la dernière version du notebook pour la partager.</p>
<p>On va améliorer cela en déployant automatiquement un site <em>web</em> présentant en page d’accueil notre rapport et permettant le téléchargement du notebook.</p>
</section>
<section id="etape-4-déploiement-de-ce-rapport-automatique-sur-le-web" class="level2">
<h2 class="anchored" data-anchor-id="etape-4-déploiement-de-ce-rapport-automatique-sur-le-web">Etape 4: Déploiement de ce rapport automatique sur le web</h2>
<p><span class="emoji" data-emoji="one">1️⃣</span> Dans un premier temps, nous allons connecter notre dépôt <code>Github</code> au service tiers <code>Netlify</code></p>
<ul>
<li>Aller sur https://www.netlify.com/ et faire <code>Sign up</code> (utiliser son compte <code>Github</code>)</li>
<li>Dans la page d’accueil de votre profil, vous pouvez cliquer sur <code>Add new site &gt; Import an existing project</code></li>
<li>Cliquer sur <code>Github</code>. S’il y a des autorisations à donner, les accorder. Rechercher votre projet dans la liste de vos projets <code>Github</code></li>
<li>Cliquer sur le nom du projet et laisser les paramètres par défaut (nous allons modifier par la suite)</li>
<li>Cliquer sur <code>Deploy site</code></li>
</ul>
<p><span class="emoji" data-emoji="two">2️⃣</span> A ce stade, votre déploiement devrait échouer. C’est normal, vous essayez de déployer depuis <code>master</code> qui ne comporte pas de html. Mais le rapport n’est pas non plus présent dans la branche <code>dev</code>. En fait, aucune branche ne comporte le rapport: celui-ci est généré dans votre <em>pipeline</em> mais n’est jamais présent dans le dépôt car il s’agit d’un <em>output</em>. On va désactiver le déploiement automatique pour privilégier un déploiement depuis <code>Github Actions</code>:</p>
<ul>
<li>Aller dans <code>Site Settings</code> puis, à gauche, cliquer sur <code>Build and Deploy</code></li>
<li>Dans la section <code>Build settings</code>, cliquer sur <code>Stop builds</code> et valider</li>
</ul>
<p>On vient de désactiver le déploiement automatique par défaut. On va faire communiquer notre dépôt <code>Github</code> et <code>Netlify</code> par le biais de l’intégration continue.</p>
<p><span class="emoji" data-emoji="three">3️⃣</span> Pour cela, il faut créer un jeton <code>Netlify</code> pour que les serveurs de <code>Github</code>, lorsqu’ils disposent d’un rapport, puissent l’envoyer à <code>Netlify</code> pour la mise sur le <em>web</em>. Il va être nécessaire de créer deux variables d’environnement pour connecter <code>Github</code> et <code>Netlify</code>: l’identifiant du site et le <em>token</em></p>
<ul>
<li>Pour le token :
<ul>
<li>Créer un jeton en cliquant, en haut à droite, sur l’icone de votre profil. Aller dans <code>User settings</code>. A gauche, cliquer sur <code>Applications</code> et créer un jeton personnel d’accès avec un nom signifiant (par exemple <code>PAT_ENSAE_reproductibilite</code>)</li>
<li>Mettre de côté (conseil : garder l’onglet ouvert)</li>
</ul></li>
<li>Pour l’identifiant du site:
<ul>
<li>cliquer sur <code>Site Settings</code> dans les onglets en haut</li>
<li>Garder l’onglet ouvert pour copier la valeur quand nécessaire</li>
</ul></li>
<li>Il est maintenant nécessaire d’aller dans le dépôt <code>Github</code> et de créer les secrets (<code>Settings &gt; Secrets &gt; Actions</code>):
<ul>
<li>Créer le secret <code>NETLIFY_AUTH_TOKEN</code> en collant la valeur du jeton d’authentification <code>Netlify</code></li>
<li>Créer le secret <code>NETLIFY_SITE_ID</code> en collant l’identifiant du site</li>
</ul></li>
</ul>
<p><span class="emoji" data-emoji="four">4️⃣</span> Nous avons effectué toutes les configurations nécessaires. On va maintenant mettre à jour l’intégration continue afin de mettre à disposition sur le <em>web</em> notre rapport. On va utiliser l’interface en ligne de commande (CLI) de <code>Netlify</code>. Celle-ci attend que le site <em>web</em> se trouve dans un dossier <code>public</code> et que la page d’accueil soit nommée <code>index.html</code>:</p>
<p></p>
<p>{{% panel name=“Vision d’ensemble” %}}</p>
<ul>
<li>une installation de <code>npm</code></li>
<li>une étape de déploiement via la CLI de netlify</li>
</ul>
<div class="sourceCode" id="cb44"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install npm</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/setup-node@v2</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">node-version</span><span class="kw">:</span><span class="at"> </span><span class="st">'14'</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Deploy to Netlify</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="co">  # NETLIFY_AUTH_TOKEN and NETLIFY_SITE_ID added in the repo's secrets</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">NETLIFY_AUTH_TOKEN</span><span class="kw">:</span><span class="at"> ${{ secrets.NETLIFY_AUTH_TOKEN }}</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">NETLIFY_SITE_ID</span><span class="kw">:</span><span class="at"> ${{ secrets.NETLIFY_SITE_ID }}</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="fu">  run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>    mkdir -p public</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>    mv report.html public/index.html</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>    mv report.ipynb public/report.ipynb</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>    npm install --unsafe-perm=true netlify-cli -g</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>    netlify init</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>    netlify deploy --prod --dir="public" --message "Deploy master"</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>{{% /panel %}}</p>
<p>{{% panel name=“Détails npm” %}}</p>
<p></p>
<ul>
<li>name: Install npm uses: actions/setup-node@v2 with: node-version: ‘14’</li>
</ul>
<p></p>
<p><code>npm</code> est le gestionnaire de paquet de JS. Il est nécessaire de le configurer, ce qui est fait automatiquement grâce à l’action <code>actions/setup-node@v2</code></p>
<p>{{% /panel %}}</p>
<p>{{% panel name=“Détails <code>Netlify CLI</code>” %}}</p>
<ul>
<li>On rappelle à <code>Github Actions</code> nos paramètres d’authentification sous forme de variables d’environnement. Cela permet de les garder secrètes</li>
</ul>
<p></p>
<ul>
<li>name: Deploy to Netlify # NETLIFY_AUTH_TOKEN and NETLIFY_SITE_ID added in the repo’s secrets env: NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }} NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }} run: | mkdir -p public mv report.html public/index.html mv report.ipynb public/report.ipynb npm install –unsafe-perm=true netlify-cli -g netlify init netlify deploy –prod –dir=“public” –message “Deploy master”</li>
</ul>
<p></p>
<ul>
<li>On déplace les rapports de la racine vers le dossier <code>public</code></li>
</ul>
<p></p>
<ul>
<li>name: Deploy to Netlify # NETLIFY_AUTH_TOKEN and NETLIFY_SITE_ID added in the repo’s secrets env: NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }} NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }} run: | mkdir -p public mv report.html public/index.html mv report.ipynb public/report.ipynb npm install –unsafe-perm=true netlify-cli -g netlify init netlify deploy –prod –dir=“public” –message “Deploy master”</li>
</ul>
<p></p>
<ul>
<li>On installe et initialise <code>Netlify</code></li>
</ul>
<p></p>
<ul>
<li>name: Deploy to Netlify # NETLIFY_AUTH_TOKEN and NETLIFY_SITE_ID added in the repo’s secrets env: NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }} NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }} run: | mkdir -p public mv report.html public/index.html mv report.ipynb public/report.ipynb npm install –unsafe-perm=true netlify-cli -g netlify init netlify deploy –prod –dir=“public” –message “Deploy master”</li>
</ul>
<p></p>
<ul>
<li>On déploie sur l’url par défaut (<code>-- prod</code>) depuis le dossier <code>public</code></li>
</ul>
<p></p>
<ul>
<li>name: Deploy to Netlify # NETLIFY_AUTH_TOKEN and NETLIFY_SITE_ID added in the repo’s secrets env: NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }} NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }} run: | mkdir -p public mv report.html public/index.html mv report.ipynb public/report.ipynb npm install –unsafe-perm=true netlify-cli -g netlify init netlify deploy –prod –dir=“public” –message “Deploy master”</li>
</ul>
<p></p>
<p>{{% /panel %}}</p>
<p></p>
<p>Au bout de quelques minutes, le rapport est disponible en ligne sur l’URL <code>Netlify</code> (par exemple https://spiffy-florentine-c913b9.netlify.app)</p>


</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>L’export dans un script <code>.py</code> a été fait avec <a href="https://jupytext.readthedocs.io/en/latest/index.html"><code>Jupytext</code></a>. Comme cela n’est pas vraiment l’objet du cours, nous passons cette étape et fournissons directement le script. Mais n’oubliez pas que cette démarche, fréquente quand on a démarré sur un <em>notebook</em> et qu’on désire consolider en faisant la transition vers des scripts, nécessite d’être attentif pour ne pas risquer de faire une erreur.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Essayez de <em>commit</em> vos changements à chaque étape de l’exercice, c’est une bonne habitude à prendre.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Nous le verrons lorsque nous mettrons en oeuvre l’intégration continue.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Ici, le jeton d’API n’est pas indispensable pour que le code fonctionne. Afin d’éviter une erreur non nécessaire lorsqu’on automatisera le processus, on peut créer une condition qui vérifie la présence ou non de ce fichier.</p>
<p>Cela peut être fait avec la fonction <code>os.path.exists</code> :</p>
<pre><code>if os.path.exists('secrets.yaml'):
    secrets = import_yaml_config("secrets.yaml")</code></pre>
<p>La variable <code>secrets</code> n’existera que dans le cas où un fichier <code>secrets.yaml</code> existe. Le script reste donc reproductible même pour un utilisateur n’ayant pas le fichier <code>secrets.yaml</code>.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>Nous proposons ici d’adopter le principe de la <strong>programmation fonctionnelle</strong>. Pour encore fiabiliser un processus, il serait possible d’adopter le paradigme de la <strong>programmation orientée objet (POO)</strong>. Celle-ci est plus rebutante et demande plus de temps au développeur. L’arbitrage coût-avantage est négatif pour notre exemple, nous proposons donc de nous en passer. Néanmoins, pour une mise en production réelle d’un modèle, il est recommandé de l’adopter. C’est d’ailleurs obligatoire avec des <a href="https://pythonds.linogaliana.fr/pipeline-scikit/"><em>pipelines</em> <code>scikit</code></a>.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>Au passage vous pouvez noter que mauvaises pratiques discutables, peuvent être corrigées, notamment l’utilisation excessive de <code>apply</code> là où il serait possible d’utiliser des méthodes embarquées par <code>Pandas</code>. Cela est plutôt de l’ordre du bon style de programmation que de la qualité formelle du script. Ce n’est donc pas obligatoire mais c’est mieux.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>Il est normal d’avoir des dossiers <code>__pycache__</code> qui traînent : ils se créent automatiquement à l’exécution d’un script en <code>Python</code>.<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8"><p>L’emplacement de ce fichier est amené à évoluer dans le cadre d’une packagisation. Dans un package, ces tests seront dans un dossier spécifique <code>/tests</code> car <code>Python</code> sait gérer de manière plus formelle les imports de fonctions depuis des modules. Ici, on est dans une situation transitoire, raison pour laquelle les tests sont dans les mêmes dossiers que les fonctions.<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9"><p>Le fichier <code>__init__.py</code> indique à <code>Python</code> que le dossier est un <em>package</em>. Il permet de proposer certaines configurations lors de l’import du <em>package</em>. Il permet également de contrôler les objets exportés (c’est-à-dire mis à disposition de l’utilisateur) par le <em>package</em> par rapport aux objets internes au <em>package</em>. En le laissant vide, nous allons utiliser ce fichier pour importer l’ensemble des fonctions de nos sous-modules. Ce n’est pas la meilleure pratique mais un contrôle plus fin des objets exportés demanderait un investissement qui ne vaut, ici, pas le coût.<a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn10"><p>Ce <code>pyproject.toml</code> est un modèle qui utilise <code>setuptools</code> pour <em>build</em> le <em>package</em>. C’est l’outil classique. Néanmoins, pour des usages plus raffinés, il peut être utile d’utiliser <a href="https://python-poetry.org/"><code>poetry</code></a> qui propose des fonctionnalités plus complètes.<a href="#fnref10" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn11"><p>Le format <code>YAML</code> est un format de fichier où les informations sont hiérarchisées. Avec le <em>package</em> <code>YAML</code> on peut très facilement le transformer en <code>dict</code>, ce qui est très pratique pour accéder à une information.<a href="#fnref11" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn12"><p>Le <code>sudo</code> n’est pas nécessaire puisque vous êtes déjà en <code>root</code><a href="#fnref12" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>
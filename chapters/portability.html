<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Romain Avouac et Lino Galiana">
<meta name="dcterms.date" content="2022-03-03">
<meta name="description" content="Pr√©sentation des principes et des techniques permettant de rendre un projet ex√©cutable sur diff√©rents environnements.">

<title>Mise en production des projets de data science - Rendre son projet de data science portable et reproductible</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Mise en production des projets de data science</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-les-bases" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Les bases</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-les-bases">    
        <li>
    <a class="dropdown-item" href="../chapters/introduction.html">
 <span class="dropdown-text">Introduction</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/linux-101.html">
 <span class="dropdown-text">Linux 101</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/git.html">
 <span class="dropdown-text">Versionner son code et travailler collaborativement avec Git</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../chapters/code-quality.html"> 
<span class="menu-text">Qualit√© du code</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/projects-architecture.html"> 
<span class="menu-text">Architecture des projets</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../chapters/portability.html" aria-current="page"> 
<span class="menu-text">Portabilit√©</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/deployment.html"> 
<span class="menu-text">Mise en production</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/application.html"> 
<span class="menu-text">Application</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/evaluation.qmd"> 
<span class="menu-text">Evaluation</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-github" role="button" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-bi-github">    
        <li>
    <a class="dropdown-item" href="https://github.com/ensae-reproductibilite/website">
 <span class="dropdown-text">Site web</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/ensae-reproductibilite/slides">
 <span class="dropdown-text">Slides</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/ensae-reproductibilite/application-correction">
 <span class="dropdown-text">Application fil rouge</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#la-notion-de-portabilit√©" id="toc-la-notion-de-portabilit√©" class="nav-link active" data-scroll-target="#la-notion-de-portabilit√©">La notion de portabilit√©</a></li>
  <li><a href="#les-environnements-virtuels" id="toc-les-environnements-virtuels" class="nav-link" data-scroll-target="#les-environnements-virtuels">Les environnements virtuels üêç</a>
  <ul class="collapse">
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#fonctionnement" id="toc-fonctionnement" class="nav-link" data-scroll-target="#fonctionnement">Fonctionnement</a></li>
  <li><a href="#impl√©mentations" id="toc-impl√©mentations" class="nav-link" data-scroll-target="#impl√©mentations">Impl√©mentations</a></li>
  <li><a href="#conda" id="toc-conda" class="nav-link" data-scroll-target="#conda">Conda</a>
  <ul class="collapse">
  <li><a href="#installation" id="toc-installation" class="nav-link" data-scroll-target="#installation">Installation</a></li>
  <li><a href="#en-pratique" id="toc-en-pratique" class="nav-link" data-scroll-target="#en-pratique">En pratique</a></li>
  <li><a href="#aide-m√©moire" id="toc-aide-m√©moire" class="nav-link" data-scroll-target="#aide-m√©moire">Aide-m√©moire</a></li>
  </ul></li>
  <li><a href="#limites" id="toc-limites" class="nav-link" data-scroll-target="#limites">Limites</a></li>
  </ul></li>
  <li><a href="#les-conteneurs" id="toc-les-conteneurs" class="nav-link" data-scroll-target="#les-conteneurs">Les conteneurs üêã</a>
  <ul class="collapse">
  <li><a href="#introduction-1" id="toc-introduction-1" class="nav-link" data-scroll-target="#introduction-1">Introduction</a></li>
  <li><a href="#fonctionnement-1" id="toc-fonctionnement-1" class="nav-link" data-scroll-target="#fonctionnement-1">Fonctionnement</a></li>
  <li><a href="#impl√©mentations-1" id="toc-impl√©mentations-1" class="nav-link" data-scroll-target="#impl√©mentations-1">Impl√©mentations</a></li>
  <li><a href="#docker" id="toc-docker" class="nav-link" data-scroll-target="#docker">Docker <i class="fab fa-docker"></i></a>
  <ul class="collapse">
  <li><a href="#installation-1" id="toc-installation-1" class="nav-link" data-scroll-target="#installation-1">Installation</a></li>
  <li><a href="#principes" id="toc-principes" class="nav-link" data-scroll-target="#principes">Principes</a></li>
  <li><a href="#en-pratique-1" id="toc-en-pratique-1" class="nav-link" data-scroll-target="#en-pratique-1">En pratique</a></li>
  <li><a href="#aide-m√©moire-1" id="toc-aide-m√©moire-1" class="nav-link" data-scroll-target="#aide-m√©moire-1">Aide-m√©moire</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Rendre son projet de data science portable et reproductible</h1>
</div>

<div>
  <div class="description">
    <p>Pr√©sentation des principes et des techniques permettant de rendre un projet ex√©cutable sur diff√©rents environnements.</p>
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Romain Avouac et Lino Galiana </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">March 3, 2022</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<details>
<summary>
D√©rouler les <em>slides</em> ci-dessous ou <a href="https://ensae-reproductibilite.github.io/slides/#/portabilit√©">cliquer ici</a> pour afficher les slides en plein √©cran.
</summary>
<div id="cb1" class="sourceCode">
<pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
<iframe class="sourceCode yaml code-with-copy" src="https://ensae-reproductibilite.github.io/slides/#/portabilit√©">
</iframe>
</div>
</details>
<section id="la-notion-de-portabilit√©" class="level1">
<h1>La notion de portabilit√©</h1>
<p>Dans les chapitres pr√©c√©dents, nous avons vu un ensemble de bonnes pratiques qui permettent de consid√©rablement am√©liorer la qualit√© d‚Äôun projet : rendre le code plus lisible, adopter une structure du projet normalis√©e et √©volutive, et versionner proprement son code sur un d√©p√¥t <code>GitHub</code>.</p>
<p>Une fois ces bonnes pratiques appliqu√©es √† notre projet, ce dernier appara√Æt largement partageable. Du moins en th√©orie, car la pratique est souvent plus compliqu√©e : il y a fort √† parier que si vous essayez d‚Äôex√©cuter votre projet sur un autre environnement d‚Äôex√©cution (un autre ordinateur, un serveur, etc.), les choses ne se passent pas du tout comme attendu. Cela signifie que qu‚Äô<strong>en l‚Äô√©tat, le projet n‚Äôest pas portable : il n‚Äôest pas possible, sans modifications co√ªteuses, de l‚Äôex√©cuter dans un environnement diff√©rent de celui dans lequel il a √©t√© d√©velopp√©</strong>.</p>
<p>La principale raison est qu‚Äôun code ne vit pas dans une bulle isol√©e, il contient en g√©n√©ral de nombreuses adh√©rences, plus ou moins visibles, au langage et √† l‚Äôenvironnement dans lesquels il a √©t√© d√©velopp√© :</p>
<ul>
<li>des d√©pendances dans le langage du projet ;</li>
<li>des d√©pendances dans d‚Äôautres langages (ex : <code>NumPy</code> est √©crit en <code>C</code> et n√©cessite donc un compilateur <code>C</code>) ;</li>
<li>des librairies syst√®mes n√©cessaires pour installer certains <em>packages</em> (par exemple, les librairies de cartographie dynamique comme <code>Leaflet</code> ou <code>Folium</code> n√©cessitent la librairie syst√®me <code>GDAL</code>), qui ne seront pas les m√™mes selon le syst√®me d‚Äôexploitation utilis√©.</li>
</ul>
<p>Si le premier probl√®me peut √™tre g√©r√© relativement facilement en adoptant une <a href="XXXXXX">structure de projet</a> et en sp√©cifiant bien les diff√©rentes d√©pendances utilis√©es, par exemple avec un fichier <code>requirements.txt</code>, les deux autres n√©cessitent en g√©n√©ral des outils plus avanc√©s.</p>
<p>Ces outils vont nous permettre de <strong>normaliser l‚Äôenvironnement afin de produire un projet portable</strong>, i.e.&nbsp;ex√©cutable sur une large vari√©t√© d‚Äôenvironnements d‚Äôex√©cution. Cette √©tape est primordiale lorsque l‚Äôon se pr√©occupe de la mise en production d‚Äôun projet, car elle assure une transition relativement indolore entre l‚Äôenvironnement de d√©veloppement et celui de production.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://img.devrant.com/devrant/rant/r_174386_yx6zV.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p><em>Image emprunt√©e √† [devrant.com}(https://devrant.com/rants/174386/when-i-say-but-it-works-on-my-machine)</em></p>
</section>
<section id="les-environnements-virtuels" class="level1">
<h1>Les environnements virtuels üêç</h1>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Pour illustrer l‚Äôimportance de travailler avec des environnements virtuels, mettons-nous √† la place d‚Äôun.e aspirant.e <em>data scientist</em> qui commencerait ses premiers projets.</p>
<p>Selon toute vraisemblance, on va commencer par installer une distribution de <code>Python</code> ‚Äî souvent, via <code>Anaconda</code> ‚Äî sur son poste et commencer √† d√©velopper, projet apr√®s projet. Dans cette approche, les diff√©rents <em>packages</em> qu‚Äôon va √™tre amen√© √† utiliser vont √™tre install√©s au m√™me endroit. Cela pose plusieurs probl√®mes :</p>
<ul>
<li><strong>conflits de version</strong> : une application A peut d√©pendre de la version 1 d‚Äôun package l√† o√π une application B peut d√©pendre de la version 2 de ce m√™me package. Une seule application peut donc fonctionner dans cette configuration ;</li>
<li><strong>version de <code>Python</code> fixe</strong> ‚Äî on ne peut avoir qu‚Äôune seule installation par syst√®me ‚Äî l√† o√π on voudrait pouvoir avoir des versions diff√©rentes selon le projet ;</li>
<li><strong>reproductiblit√© limit√©e</strong> : difficile de dire quel projet repose sur tel package, dans la mesure o√π ceux-ci s‚Äôaccumulent en un m√™me endroit au fil des projets ;</li>
<li><strong>portabilit√© limit√©e</strong> : cons√©quence du point pr√©c√©dent, il est difficile de fixer dans un fichier les d√©pendances sp√©cifiques √† un projet.</li>
</ul>
<p>Les environnements virtuels constituent une solution √† ces diff√©rents probl√®mes.</p>
</section>
<section id="fonctionnement" class="level2">
<h2 class="anchored" data-anchor-id="fonctionnement">Fonctionnement</h2>
<p>Le concept d‚Äôenvironnement virtuel est techniquement tr√®s simple. On peut lui donner la d√©finition suivante pour <code>Python</code> :</p>
<blockquote class="blockquote">
<p><em>‚Äúdossier auto-suffisant qui contient une installation de <code>Python</code> pour une version particuli√®re de <code>Python</code> ainsi que des <em>packages</em> additionnels et qui est isol√© des autres environnements existants.‚Äù</em></p>
</blockquote>
<p>On peut donc simplement voir les environnements virtuels comme un moyen de faire cohabiter sur un m√™me syst√®me diff√©rentes installations de <code>Python</code> avec chacune leur propre liste de packages install√©s et leurs versions. D√©velopper dans des environnements virtuels vierges √† chaque d√©but de projet est une tr√®s bonne pratique pour accro√Ætre la reproductibilit√© des analyses.</p>
</section>
<section id="impl√©mentations" class="level2">
<h2 class="anchored" data-anchor-id="impl√©mentations">Impl√©mentations</h2>
<p>Il existe diff√©rentes impl√©mentations des environnements virtuels en <code>Python</code>, dont chacune ont leurs sp√©cificit√©s et leur communaut√© d‚Äôutilisateurs :</p>
<ul>
<li>L‚Äôimpl√©mentation standard en <code>Python</code> est <code>venv</code>.</li>
<li>Dans le domaine de la <em>data science</em>, l‚Äôimpl√©mentation la plus courante est sans doute <code>conda</code>.</li>
</ul>
<p>En pratique, ces impl√©mentations sont relativement proches. La diff√©rence majeure est que <code>conda</code> est √† la fois un <em>package manager</em> (comme <code>pip</code>) et un gestionnaire d‚Äôenvironnements virtuels (comme <code>venv</code>).</p>
<p>Pendant longtemps, <code>conda</code> en tant que <em>package manager</em> s‚Äôest av√©r√© tr√®s pratique en <em>data science</em>, dans la mesure o√π il g√©rait non seulement les d√©pendances <code>Python</code> mais aussi dans d‚Äôautres langages ‚Äî comme des d√©pendances <code>C</code>. L‚Äôautre diff√©rence majeure avec <code>pip</code> est que Conda utilise une m√©thode plus avanc√©e ‚Äî et donc √©galement plus co√ªteuse en temps ‚Äî de r√©solution des d√©pendances<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. En effet, diff√©rents packages peuvent sp√©cifier diff√©rentes versions d‚Äôun m√™me package dont ils d√©pendent tous les deux, ce qui provoque un conflit de version. Conda va par d√©faut appliquer un algorithme qui vise √† g√©rer au mieux ces conflits, l√† o√π <code>pip</code> va choisir une approche plus minimaliste. Enfin, la <em>distribution</em> <code>Anaconda</code>, qui contient √† la fois <code>Python</code>, <code>conda</code> et beaucoup de <em>packages</em> utiles pour la <em>data science</em>, explique √©galement cette popularit√© aupr√®s des <em>data scientists</em>.</p>
<p>Pour toutes ces raisons, nous allons pr√©senter l‚Äôutilisation de <code>conda</code> comme gestionnaire d‚Äôenvironnements virtuels. Les principes pr√©sent√©s restent n√©anmoins valides pour les autres impl√©mentations.</p>
</section>
<section id="conda" class="level2">
<h2 class="anchored" data-anchor-id="conda">Conda</h2>
<section id="installation" class="level3">
<h3 class="anchored" data-anchor-id="installation">Installation</h3>
<p>Les instructions √† suivre pour installer <code>conda</code> sont d√©taill√©es dans la <a href="https://docs.conda.io/projects/conda/en/latest/user-guide/install/index.html">documentation officielle</a>. <code>conda</code> seul √©tant peu utile en pratique, il est g√©n√©ralement install√© dans le cadre de distributions. Les deux plus populaires sont :</p>
<ul>
<li><code>Miniconda</code> : une distribution minimaliste contenant <code>conda</code>, <code>Python</code> ainsi qu‚Äôun petit nombre de packages techniques tr√®s utiles ;</li>
<li><code>Anaconda</code> : une distribution assez volumineuse contenant <code>conda</code>, <code>Python</code>, d‚Äôautres logiciels (<code>R</code>, <code>Spyder</code>, etc.) ainsi qu‚Äôun ensemble de packages utiles pour la <em>data science</em> (<code>SciPy</code>, <code>NumPy</code>, etc.).</li>
</ul>
<p>Le choix de la distribution importe assez peu en pratique, dans la mesure o√π nous allons de toute mani√®re utiliser des environnements virtuels vierges pour d√©velopper nos projets.</p>
<p><strong>L‚Äô√©cosyst√®me Conda</strong></p>
<p><img src="../conda-eco.png" class="img-fluid"></p>
</section>
<section id="en-pratique" class="level3">
<h3 class="anchored" data-anchor-id="en-pratique">En pratique</h3>
<section id="cr√©er-un-environnement" class="level4">
<h4 class="anchored" data-anchor-id="cr√©er-un-environnement">Cr√©er un environnement</h4>
<p>Pour commencer √† utiliser <code>conda</code>, commen√ßons par cr√©er un environnement vierge, nomm√© <code>dev</code>, en sp√©cifiant la version de Python que l‚Äôon souhaite installer pour notre projet.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> conda create <span class="at">-n</span> dev python=3.9.7</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Collecting</span> package metadata <span class="er">(</span><span class="ex">current_repodata.json</span><span class="kw">)</span><span class="bu">:</span> done</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Solving</span> environment: done</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">## Package Plan ##</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="ex">environment</span> location: /home/coder/local/bin/conda/envs/dev</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="ex">added</span> / updated specs:</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-</span> python=3.9.7</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="ex">The</span> following packages will be downloaded:</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="ex">The</span> following NEW packages will be INSTALLED:</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="ex">Proceed</span> <span class="er">(</span><span class="ex">[y]/n</span><span class="kw">)</span><span class="ex">?</span> y</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="ex">Downloading</span> and Extracting Packages</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Comme indiqu√© dans les logs, <code>Conda</code> a cr√©√© notre environnement et nous indique son emplacement sur le <em>filesystem</em>. En r√©alit√©, l‚Äôenvironnement n‚Äôest jamais vraiment vierge : <code>Conda</code> nous demande ‚Äî et il faut r√©pondre oui en tapant <em>‚Äúy‚Äù</em> ‚Äî d‚Äôinstaller un certain nombre de packages, qui sont ceux qui viennent avec la distribution <code>Miniconda</code>.</p>
<p>On peut v√©rifier que l‚Äôenvironnement a bien √©t√© cr√©√© en listant les environnements install√©s sur le syst√®me.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> info <span class="at">--envs</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># conda environments:</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="ex">base</span>                    <span class="pp">*</span> /home/coder/local/bin/conda</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="ex">basesspcloud</span>              /home/coder/local/bin/conda/envs/basesspcloud</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="ex">dev</span>                       /home/coder/local/bin/conda/envs/dev</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="activer-un-environnement" class="level4">
<h4 class="anchored" data-anchor-id="activer-un-environnement">Activer un environnement</h4>
<p>Comme plusieurs environnements peuvent coexister sur un m√™me syst√®me, il faut sp√©cifier √† <code>Conda</code> que l‚Äôon souhaite utiliser cet environnement pour la session courante du terminal.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> conda activate dev</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>Conda</code> nous indique que l‚Äôon travaille √† partir de maintenant dans l‚Äôenvironnement <code>dev</code> en indiquant son nom entre parenth√®ses au d√©but de la ligne de commandes. Autrement dit, <code>dev</code> devient pour un temps notre environnement par d√©faut. Pour s‚Äôen assurer, v√©rifions avec la commande <code>which</code> l‚Äôemplacement de l‚Äôinterpr√©teur Python qui sera utilis√© si on lance une commande du type <code>python mon-script.py</code>.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">dev</span><span class="kw">)</span> <span class="ex">$</span> which python </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="ex">/home/coder/local/bin/conda/envs/dev/bin/python</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>On travaille bien dans l‚Äôenvironnement attendu : l‚Äôinterpr√©teur qui se lance n‚Äôest pas celui du syst√®me global, mais bien celui sp√©cifique √† notre environnement virtuel.</p>
</section>
<section id="lister-les-packages-install√©s" class="level4">
<h4 class="anchored" data-anchor-id="lister-les-packages-install√©s">Lister les packages install√©s</h4>
<p>Une fois l‚Äôenvironnement activ√©, on peut lister les packages install√©s et leur version. Cela confirme qu‚Äôun certain nombre de packages sont install√©s par d√©faut lors de la cr√©ation d‚Äôun environnement virtuel.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">dev</span><span class="kw">)</span> <span class="ex">$</span> conda list</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># packages in environment at /home/coder/local/bin/conda/envs/dev:</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Name                    Version                   Build  Channel</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="ex">_libgcc_mutex</span>             0.1                        main  </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="ex">_openmp_mutex</span>             4.5                       1_gnu  </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="ex">ca-certificates</span>           2022.3.29            h06a4308_0  </span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="installer-un-package" class="level4">
<h4 class="anchored" data-anchor-id="installer-un-package">Installer un package</h4>
<p>La syntaxe pour installer un package avec Conda est tr√®s similaire √† celle de <code>pip</code> :</p>
<pre class="shell"><code>conda install nom_du_package</code></pre>
<p>La diff√©rence est que l√† o√π <code>pip install</code> va installer un package √† partir du r√©pertoire <a href="https://pypi.org/">PyPI</a>, <code>conda install</code> va chercher le package sur les r√©pertoires maintenus par les d√©veloppeurs de Conda<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>. Installons par exemple le package phare de <em>machine learning</em> <code>scikit-learn</code>.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">dev</span><span class="kw">)</span> <span class="ex">$</span> conda install scikit-learn</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Collecting</span> package metadata <span class="er">(</span><span class="ex">current_repodata.json</span><span class="kw">)</span><span class="bu">:</span> done</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Solving</span> environment: done</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">## Package Plan ##</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="ex">environment</span> location: /home/coder/local/bin/conda/envs/dev</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="ex">added</span> / updated specs:</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-</span> scikit-learn</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>L√† encore, Conda nous demande d‚Äôinstaller d‚Äôautres packages, qui sont des d√©pendances de <code>scikit-learn</code>. Par exemple, la librairie de calcul scientifique <code>NumPy</code>.</p>
<p>Il arrive que des packages disponibles sur le r√©pertoire <code>PyPI</code> ne soient pas disponible sur les canaux g√©r√©s par Conda. Dans ce cas, il est possible d‚Äôinstaller un package dans l‚Äôenvironnement via la commande <code>pip install</code>. Il est n√©anmonins toujours pr√©f√©rable de privil√©gier une installation via Conda si disponible.</p>
</section>
<section id="exporter-les-sp√©cifications-de-lenvironnement" class="level4">
<h4 class="anchored" data-anchor-id="exporter-les-sp√©cifications-de-lenvironnement">Exporter les sp√©cifications de l‚Äôenvironnement</h4>
<p>D√©velopper √† partir d‚Äôun environnement vierge est une bonne pratique de reproductibilit√© : en partant d‚Äôune base minimale, on s‚Äôassure que seuls les packages effectivement n√©cessaires au bon fonctionnement de notre application ont √©t√© install√©s au fur et √† mesure du projet.</p>
<p>Cela rend √©galement notre projet plus portable : on peut exporter les sp√©cifications de l‚Äôenvironnement (version de Python, canaux de t√©l√©chargement des packages, packages install√©s et leurs versions) dans un fichier, appel√© par convention <code>environment.yml</code>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">dev</span><span class="kw">)</span> <span class="ex">$</span> conda env export <span class="op">&gt;</span> environment.yml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Ce fichier est mis par convention √† la racine du d√©p√¥t <code>Git</code> du projet. Ainsi, les personnes souhaitant tester l‚Äôapplication peuvent recr√©er le m√™me environnement Conda que celui qui a servi au d√©veloppement via la commande suivante.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> conda env create <span class="at">-f</span> environment.yml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="changer-denvironnement" class="level4">
<h4 class="anchored" data-anchor-id="changer-denvironnement">Changer d‚Äôenvironnement</h4>
<p>Pour changer d‚Äôenvironnement, il suffit d‚Äôen activer un autre.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">dev</span><span class="kw">)</span> <span class="ex">$</span> conda base</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">base</span><span class="kw">)</span> <span class="ex">$</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Pour sortir de tout environnement Conda, on utilise la commande <code>conda deactivate</code> :</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">base</span><span class="kw">)</span> <span class="ex">$</span> conda deactivate</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="supprimer-un-environnement" class="level4">
<h4 class="anchored" data-anchor-id="supprimer-un-environnement">Supprimer un environnement</h4>
<p>Pour supprimer l‚Äôenvironnement <code>dev</code>, on utilise la commande <code>conda env remove -n dev</code>.</p>
</section>
</section>
<section id="aide-m√©moire" class="level3">
<h3 class="anchored" data-anchor-id="aide-m√©moire">Aide-m√©moire</h3>
<table class="table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th>Commande</th>
<th>Principe</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>conda create -n &lt;env_name&gt; python=&lt;python_version&gt;</code></td>
<td>Cr√©ation d‚Äôun environnement nomm√© <code>&lt;env_name&gt;</code> dont la version de Python est <code>&lt;python_version&gt;</code></td>
</tr>
<tr class="even">
<td><code>conda info --envs</code></td>
<td>Lister les environnements</td>
</tr>
<tr class="odd">
<td><code>conda activate &lt;env_name&gt;</code></td>
<td>Utiliser l‚Äôenvironnement <code>&lt;env_name&gt;</code> pour la session du terminal</td>
</tr>
<tr class="even">
<td><code>conda list</code></td>
<td>Lister les <em>packages</em> dans l‚Äôenvironnement actif</td>
</tr>
<tr class="odd">
<td><code>conda install &lt;pkg&gt;</code></td>
<td>Installer le <em>package</em> <code>&lt;pkg&gt;</code> dans l‚Äôenvironnement actif</td>
</tr>
<tr class="even">
<td><code>conda env export &gt; environment.yml</code></td>
<td>Exporter les sp√©cifications de l‚Äôenvironnement dans un fichier <code>environment.yml</code></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="limites" class="level2">
<h2 class="anchored" data-anchor-id="limites">Limites</h2>
<p>D√©velopper dans des environnements virtuels est une bonne pratique, car cela accro√Æt la portabilit√© d‚Äôune application. N√©anmoins, il y a plusieurs limites √† leur utilisation :</p>
<ul>
<li>les librairies syst√®me n√©cessaires √† l‚Äôinstallation des packages ne sont pas g√©r√©es ;</li>
<li>les environnements virtuels ne permettent pas toujours de g√©rer des projets faisant intervenir diff√©rents langages de programmation ;</li>
<li>devoir installer <code>conda</code>, <code>Python</code>, et les packages n√©cessaires √† chaque changement d‚Äôenvironnement peut √™tre assez long et p√©nible en pratique ;</li>
<li>dans un environnement de production, g√©rer des environnements virtuels diff√©rents pour chaque projet peut s‚Äôav√©rer rapidement complexe pour les administrateurs syst√®me.</li>
</ul>
<p>La technologie des conteneurs permet de r√©pondre √† ces diff√©rents probl√®mes.</p>
</section>
</section>
<section id="les-conteneurs" class="level1">
<h1>Les conteneurs üêã</h1>
<section id="introduction-1" class="level2">
<h2 class="anchored" data-anchor-id="introduction-1">Introduction</h2>
<p>Avec les environnements virtuels, l‚Äôid√©e √©tait de permettre √† chaque utilisateur potentiel de notre projet d‚Äôinstaller sur son environnement d‚Äôex√©cution les packages n√©cessaires √† la bonne ex√©cution du projet. N√©anmoins, comme on l‚Äôa vu, cette approche ne garantit pas une reproductibilit√© parfaite et a l‚Äôinconv√©nient de n√©cessiter beaucoup de gestion manuelle.</p>
<p>Changeons de perspective : <em>au lieu de distribuer une recette permettant √† l‚Äôutilisateur de recr√©er l‚Äôenvironnement n√©cessaire sur sa machine, ne pourrait-on pas directement distribuer √† l‚Äôutilisateur une machine contenant l‚Äôenvironnement pr√©-configur√© ?</em></p>
<p>Bien entendu, on ve pas configurer et envoyer des ordinateurs portables √† tous les utilisateurs potentiels d‚Äôun projet. Une autre solution serait de distribuer des machines virtuelles, qui tournent sur un serveur et simulent un v√©ritable ordinateur. Ces machines ont cependant l‚Äôinconv√©nient d‚Äô√™tre assez lourdes, et complexes √† r√©pliquer et distribuer. Pour pallier ces diff√©rentes limites, on va utiliser la technologie des conteneurs.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://external-preview.redd.it/aR6WdUcsrEgld5xUlglgKX_0sC_NlryCPTXIHk5qdu8.jpg?auto=webp&amp;s=5fe64dd318eec71711d87805d43def2765dd83cd" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p><em>Image trouv√©e sur <a href="https://www.reddit.com/r/ProgrammerHumor/comments/cw58z7/it_works_on_my_machine/">reddit</a></em></p>
</section>
<section id="fonctionnement-1" class="level2">
<h2 class="anchored" data-anchor-id="fonctionnement-1">Fonctionnement</h2>
<p>Comme les machines virtuelles, les conteneurs permettent d‚Äôempaqueter compl√®tement l‚Äôenvironnement (librairies syst√®mes, application, configuration) qui permet de faire tourner l‚Äôapplication. Mais √† l‚Äôinverse d‚Äôune machine virtuelle, le conteneur n‚Äôinclut pas de syst√®me d‚Äôexploitation propre, il utilise celui de la machine h√¥te qui l‚Äôex√©cute. La technologie des conteneurs permet ainsi de garantir une tr√®s forte reproductibilit√© tout en restant suffisamment l√©g√®re pour permettre une distribution et un d√©ploiement simple aux utilisateurs.</p>
<p><strong>Diff√©rences entre l‚Äôapproche conteneurs (gauche) et l‚Äôapproche machines virtuelles (droite)</strong></p>
<p><img src="../docker-vm.png" class="img-fluid"></p>
<p>Source : <a href="https://www.docker.com/resources/what-container/">docker.com</a></p>
</section>
<section id="impl√©mentations-1" class="level2">
<h2 class="anchored" data-anchor-id="impl√©mentations-1">Impl√©mentations</h2>
<p>Comme pour les environnements virtuels, il existe diff√©rentes impl√©mentations de la technologie des conteneurs. En pratique, l‚Äôimpl√©mentation offerte par <code>Docker</code> est devenue largement pr√©dominante, au point qu‚Äôil est devenu courant d‚Äôutiliser de mani√®re interchangeable les termes <em>‚Äúconteneuriser‚Äù</em> et <em>‚ÄúDockeriser‚Äù</em> une application. C‚Äôest donc cette impl√©mentation que nous allons √©tudier et utiliser dans ce cours.</p>
</section>
<section id="docker" class="level2">
<h2 class="anchored" data-anchor-id="docker">Docker <i class="fab fa-docker"></i></h2>
<section id="installation-1" class="level3">
<h3 class="anchored" data-anchor-id="installation-1">Installation</h3>
<p>Les instructions √† suivre pour installer <code>Docker</code> <i class="fab fa-docker"></i> selon son syst√®me d‚Äôexploiration sont d√©taill√©es dans la <a href="https://docs.docker.com/get-docker/">documentation officielle</a>. Il existe √©galement des environnements bacs √† sable en ligne comme <a href="https://labs.play-with-docker.com">Play with Docker</a>.</p>
</section>
<section id="principes" class="level3">
<h3 class="anchored" data-anchor-id="principes">Principes</h3>
<p>Un conteneur Docker est mis √† disposition sous la forme d‚Äôune <strong>image</strong>, c‚Äôest √† dire d‚Äôun fichier binaire qui contient l‚Äôenvironnement n√©cessaire √† l‚Äôex√©cution de l‚Äôapplication.</p>
<p>Pour construire (<em>build</em>) l‚Äôimage, on utilise un <code>Dockerfile</code>, un fichier texte qui contient la recette ‚Äî sous forme de commandes Linux ‚Äî de construction de l‚Äôenvironnement. L‚Äôimage va √™tre upload√©e (<em>push</em>) sur un d√©p√¥t (<em>registry</em>), public ou priv√©, depuis lequel les utilisateurs vont pouvoir t√©l√©charger l‚Äôimage (<em>pull</em>). Le moteur Docker permet ensuite de lancer (<em>run</em>) un <strong>conteneur</strong>, c‚Äôest √† dire une instance vivante de l‚Äôimage.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Le r√©pertoire d‚Äôimages publiques le plus connu est <a href="https://hub.docker.com/"><code>DockerHub</code></a>. Il s‚Äôagit d‚Äôun r√©pertoire o√π n‚Äôimporte qui peut proposer une image <code>Docker</code>, associ√©e ou non √† un projet disponible sur <code>Github</code> ou <code>Gitlab</code>. Il est possible de mettre √† disposition de mani√®re manuelle des images mais, comme nous le montrerons dans le chapitre sur la <a href="../chapters/deployment.html">mise en production</a>, il est beaucoup plus pratique d‚Äôutiliser des fonctionalit√©s d‚Äôinteraction automatique entre <code>DockerHub</code> et un d√©p√¥t <code>GitHub</code>.</p>
</div>
</div>
</section>
<section id="en-pratique-1" class="level3">
<h3 class="anchored" data-anchor-id="en-pratique-1">En pratique</h3>
<section id="application" class="level4">
<h4 class="anchored" data-anchor-id="application">Application</h4>
<p>Afin de pr√©senter l‚Äôutilisation de <code>Docker</code> en pratique, nous allons pr√©senter les diff√©rentes √©tapes permettant de <em>‚Äúdockeriser‚Äù</em> une application web minimaliste construite avec le <em>framework</em> <code>Python</code> <a href="https://flask.palletsprojects.com/en/2.1.x/"><code>Flask</code></a><a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>.</p>
<p>La structure de notre projet est la suivante.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">‚îú‚îÄ‚îÄ</span> myflaskapp</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="ex">‚îÇ</span>   ‚îú‚îÄ‚îÄ Dockerfile</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="ex">‚îÇ</span>   ‚îú‚îÄ‚îÄ hello-world.py</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="ex">‚îÇ</span>   ‚îî‚îÄ‚îÄ requirements.txt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Le script <code>hello-world.py</code> contient le code d‚Äôune application minimaliste, qui affiche simplement <em>‚ÄúHello, World!‚Äù</em> sur une page web.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask <span class="im">import</span> Flask</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> Flask(<span class="va">__name__</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="at">@app.route</span>(<span class="st">"/"</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hello_world():</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">"&lt;p&gt;Hello, World!&lt;/p&gt;"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Pour faire tourner l‚Äôapplication, il nous faut donc √† la fois <code>Python</code> et le package <code>Flask</code>. Ces installations doivent √™tre sp√©cifi√©es dans le <code>Dockerfile</code> (cf.&nbsp;<a href="#dockerfile">section suivante</a>). L‚Äôinstallation de <code>Flask</code> se fait via un fichier <code>requirements.txt</code>, qui contient juste la ligne suivante :</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="va">Flask</span><span class="op">=</span>=2.1.1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="dockerfile" class="level4">
<h4 class="anchored" data-anchor-id="dockerfile">Le <code>Dockerfile</code></h4>
<p>A l√† base de chaque image <code>Docker</code> se trouve un <code>Dockerfile</code>. C‚Äôest un fichier texte qui contient une s√©rie de commandes qui permettent de construire l‚Äôimage. Ces fichiers peuvent √™tre plus ou moins complexes selon l‚Äôapplication que l‚Äôon cherche √† conteneuriser, mais leur structure est assez normalis√©e. Pour s‚Äôen rendre compte, analysons ligne √† ligne le <code>Dockerfile</code> n√©cessaire pour construire une image <code>Docker</code> de notre application <code>Flask.</code></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">FROM</span> ubuntu:20.04</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="ex">RUN</span> apt-get update <span class="at">-y</span> <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">apt-get</span> install <span class="at">-y</span> python3-pip python3-dev</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="ex">WORKDIR</span> /app</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="ex">COPY</span> requirements.txt /app/requirements.txt</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="ex">RUN</span> pip install <span class="at">-r</span> requirements.txt</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="ex">COPY</span> . /app</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="ex">ENV</span> FLASK_APP=<span class="st">"hello-world.py"</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="ex">EXPOSE</span> 5000</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="ex">CMD</span> [<span class="st">"flask"</span>, <span class="st">"run"</span>, <span class="st">"--host=0.0.0.0"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>FROM</code> : sp√©cifie l‚Äôimage de base. Une image Docker h√©rite toujours d‚Äôune image de base. Ici, on choisit l‚Äôimage <code>Ubuntu</code> version <code>20.04</code>, tout va donc se passer comme si l‚Äôon d√©veloppait sur une machine virtuelle vierge ayant pour syst√®me d‚Äôexploitation <code>Ubuntu 20.04</code><a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> ;</li>
<li><code>RUN</code> : lance une commande Linux. Ici, on met d‚Äôabord √† jour la liste des packages t√©l√©chargeables via <code>apt</code>, puis on installe <code>Python</code> ainsi que des librairies syst√®me n√©cessaires au bon fonctionnement de notre application ;</li>
<li><code>WORKDIR</code> : sp√©cifie le r√©pertoire de travail de l‚Äôimage. Ainsi, toutes les commandes suivantes seront ex√©cut√©es depuis ce r√©pertoire ;</li>
<li><code>COPY</code> : copie un fichier local sur l‚Äôimage <code>Docker</code>. Ici, on copie d‚Äôabord le fichier <code>requirements.txt</code> du projet, qui sp√©cifie les d√©pendances <code>Python</code> de notre application, puis on les installe avec une commande <code>RUN</code>. La seconde instruction <code>COPY</code> copie le r√©pertoire du projet sur l‚Äôimage ;</li>
<li><code>ENV</code> : cr√©e une variable d‚Äôenvironnement qui sera accessible √† l‚Äôapplication dans le conteneur. Ici, on d√©finit une variable d‚Äôenvironnement attendue par <code>Flask</code>, qui sp√©cifie le nom du script permettant de lancer l‚Äôapplication ;</li>
<li><code>EXPOSE</code> : informe <code>Docker</code> que le conteneur ‚Äú√©coute‚Äù sur le port 5000, qui est le port par d√©faut utilis√© par le serveur web de <code>Flask</code> ;</li>
<li><code>CMD</code> : sp√©cifie la commande que doit ex√©cuter le conteneur lors de son lancement. Il s‚Äôagit d‚Äôune liste, qui contient les diff√©rentes parties de la commande sous forme de cha√Ænes de caract√®res. Ici, on lance <code>Flask</code>, qui sait automatiquement quelle application lancer du fait de la commande <code>ENV</code> sp√©cifi√©e pr√©c√©demment.</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Avec la premi√®re commande <code>RUN</code> du <code>Dockerfile</code>, nous installons <code>Python</code> mais aussi des librairies syst√®me n√©cessaires au bon fonctionnement de l‚Äôapplication. Mais comment les avons-nous trouv√©es ?</p>
<p>Par essai et erreur. Lors de l‚Äô√©tape de <a href="#build">build</a> que l‚Äôon verra juste apr√®s, le moteur <code>Docker</code> va essayer de construire l‚Äôimage selon les sp√©cifications du <code>Dockerfile</code>, comme s‚Äôil partait d‚Äôun ordinateur vide contenant simplement <code>Ubuntu 20.04</code>. Si des librairies manquent, le processus de <em>build</em> devrait renvoyer une erreur, qui s‚Äôaffichera dans les <em>logs</em> de l‚Äôapplication, affich√©s par d√©faut dans la console. Quand on a de la chance, les logs d√©crivent explicitement les librairies syst√®me manquantes. Mais souvent, les messages d‚Äôerreur ne sont pas tr√®s explicites, et il faut alors les copier dans un moteur de recherche bien connu pour trouver la r√©ponse, souvent sur <a href="https://stackoverflow.com/">Stackoverflow</a>.</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>La recette pr√©sente dans le <code>Dockerfile</code> peut n√©cessiter l‚Äôutilisation de fichiers appartenant au dossier de travail. Pour que <code>Docker</code> les trouve dans son contexte, il est n√©cessaire d‚Äôintroduire une commande <code>COPY</code>. C‚Äôest un petit peu comme pour la cuisine: pour utiliser un produit dans une recette, il faut le sortir du frigo (fichier local) et le mettre sur la table.</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Nous n‚Äôavons vu que les commandes <code>Docker</code> les plus fr√©quentes, il en existe beaucoup d‚Äôautres en pratique. N‚Äôh√©sitez pas √† consulter la <a href="https://docs.docker.com/engine/reference/builder/">documentation officielle</a> pour comprendre leur utilisation.</p>
</div>
</div>
</section>
<section id="build" class="level4">
<h4 class="anchored" data-anchor-id="build">Construction d‚Äôune image Docker</h4>
<p>Pour construire une image √† partir d‚Äôun <code>Dockerfile</code>, il suffit d‚Äôutiliser la commande <code>docker build</code>. Il faut ensuite sp√©cifier deux √©l√©ments importnats : - le <em>build context</em>. Il faut indiquer √† <code>Docker</code> le chemin de notre projet, qui doit contenir le <code>Dockerfile</code>. En pratique, il est plus simple de se mettre dans le dossier du projet via la commande <code>cd</code>, puis de passer <code>.</code> comme <em>build context</em> pour indiquer √† <code>Docker</code> de <em>build</em> ‚Äúd‚Äôici‚Äù ; - le <em>tag</em>, c‚Äôest √† dire le nom de l‚Äôimage. Tant que l‚Äôon utilisee <code>Docker</code> en local, le <em>tag</em> importe peu. On verra par la suite que la structure du <em>tag</em> a de l‚Äôimportance lorsque l‚Äôon souhaite <a href="#imp-docker">exporter</a> ou <a href="#exp-docker">importer</a> une image <code>Docker</code> √† partir d‚Äôun d√©p√¥t distant.</p>
<p>Regardons ce qui se passe en pratique lorsque l‚Äôon essaie de construire notre image.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> docker build <span class="at">-t</span> myflaskapp .</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Sending</span> build context to Docker daemon     47MB</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Step</span> 1/8 : FROM ubuntu:20.04</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a> <span class="ex">---</span><span class="op">&gt;</span> 825d55fb6340</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Step</span> 2/8 : RUN apt-get update <span class="kw">&amp;&amp;</span> <span class="ex">apt-get</span> install <span class="at">-y</span> python3-pip python3-dev</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a> <span class="ex">---</span><span class="op">&gt;</span> Running in 92b42d579cfa</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="ex">done.</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="ex">Removing</span> intermediate container 92b42d579cfa</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a> <span class="ex">---</span><span class="op">&gt;</span> 8826d53e3c01</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="ex">Step</span> 3/8 : WORKDIR /app</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a> <span class="ex">---</span><span class="op">&gt;</span> Running in 153b32893c23</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="ex">Removing</span> intermediate container 153b32893c23</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a> <span class="ex">---</span><span class="op">&gt;</span> 7b4d22021986</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="ex">Step</span> 4/8 : COPY requirements.txt /app/requirements.txt</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="ex">Successfully</span> built 125bd8da70ff</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="ex">Successfully</span> tagged myflaskapp:latest</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Le moteur <code>Docker</code> essaie de construire notre image s√©quentiellement √† partir des commandes sp√©cifi√©es dans le <code>Dockerfile</code>. S‚Äôil rencontre une erreur, la proc√©dure s‚Äôarr√™te, et il faut alors trouver la source du probl√®me dans les <em>logs</em> et adapter le <code>Dockerfile</code> en cons√©quence. Si tout se passe bien, <code>Docker</code> nous indique que le <em>build</em> a r√©ussi et l‚Äôimage est pr√™te √† √™tre utilis√©e. On peut v√©rifier que l‚Äôimage est bien disponible √† l‚Äôaide de la commande <code>docker images</code>.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> docker images</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="ex">REPOSITORY</span>                               TAG       IMAGE ID       CREATED          SIZE</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="ex">myflaskapp</span>                               latest    57d2f410a631   2 hours ago      433MB</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Int√©ressons nous un peu plus en d√©tail aux <em>logs</em> de l‚Äô√©tape de <em>build</em>. Entre les √©tapes, <code>Docker</code> affiche des suites de lettres et de chiffres un peu √©sot√©riques, et nous parle de conteneurs interm√©diaires. En fait, il faut voir une image <code>Docker</code> comme un empilement de couches (<em>layers</em>), qui sont elles-m√™mes des images <code>Docker</code>. Quand on h√©rite d‚Äôune image avec l‚Äôinstruction <code>FROM</code>, on sp√©cifie donc √† <code>Docker</code> la couche initiale, sur laquelle il va construire le reste de notre environnement. A chaque √©tape sa nouvelle couche, et √† chaque couche son <em>hash</em>, un identifiant unique fait de lettres et de chiffres.</p>
<p>Cela peut ressembler √† des d√©tails techniques, mais c‚Äôest en fait extr√™mement utile en pratique car cela permet √† <code>Docker</code> de faire du <em>caching</em>. Lorsque l‚Äôon d√©veloppe un <code>Dockerfile</code>, il est fr√©quent de devoir modifier ce dernier de nombreuses fois avant de trouver la bonne recette, et on aimerait bien ne pas avoir √† <em>rebuild</em> l‚Äôenvironnement complet √† chaque fois. <code>Docker</code> g√®re cela tr√®s bien : il <em>cache</em> chacune des couches interm√©diaires. Par exemple, si l‚Äôon modifie la 5√®me commande du <code>Dockerfile</code>, <code>Docker</code> va utiliser le cache pour ne pas avoir √† recalculer les √©tapes pr√©c√©dentes, qui n‚Äôont pas chang√©. Cela s‚Äôappelle l‚Äô<em>‚Äúinvalidation du cache‚Äù</em> : d√®s lors qu‚Äôune √©tape du <code>Dockerfile</code> est modifi√©e, <code>Docker</code> va recalculer toutes les √©tapes suivantes, mais seulement celles-ci. Cons√©quence directe de cette observation : il faut toujours ordonner les √©tapes d‚Äôun <code>Dockerfile</code> de sorte √† ce qui est le plus susceptible d‚Äô√™tre souvent modifi√© soit √† la fin du fichier, et inversement.</p>
<p>Pour illustrer cela, regardons ce qui se passe si l‚Äôon modifie le nom du script qui lance l‚Äôapplication, et donc la valeur de la variable d‚Äôenvironnement <code>FLASK_APP</code> dans le <code>Dockerfile</code>.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> docker build . <span class="at">-t</span> myflaskapp</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Sending</span> build context to Docker daemon  4.096kB</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Step</span> 1/10 : FROM ubuntu:20.04</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a> <span class="ex">---</span><span class="op">&gt;</span> 825d55fb6340</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Step</span> 2/10 : ENV DEBIAN_FRONTEND=noninteractive</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a> <span class="ex">---</span><span class="op">&gt;</span> Using cache</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a> <span class="ex">---</span><span class="op">&gt;</span> ea1c7c083ac9</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="ex">Step</span> 3/10 : RUN apt-get update <span class="at">-y</span> <span class="kw">&amp;&amp;</span>     <span class="ex">apt-get</span> install <span class="at">-y</span> python3-pip python3-dev</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a> <span class="ex">---</span><span class="op">&gt;</span> Using cache</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a> <span class="ex">---</span><span class="op">&gt;</span> 078b8ac0e1cb</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="ex">Step</span> 4/10 : WORKDIR /app</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a> <span class="ex">---</span><span class="op">&gt;</span> Using cache</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a> <span class="ex">---</span><span class="op">&gt;</span> cd19632825b3</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="ex">Step</span> 5/10 : COPY requirements.txt /app/requirements.txt</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a> <span class="ex">---</span><span class="op">&gt;</span> Using cache</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a> <span class="ex">---</span><span class="op">&gt;</span> 271cd1686899</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="ex">Step</span> 6/10 : RUN pip install <span class="at">-r</span> requirements.txt</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a> <span class="ex">---</span><span class="op">&gt;</span> Using cache</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a> <span class="ex">---</span><span class="op">&gt;</span> 3ea406fdf383</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="ex">Step</span> 7/10 : COPY . /app</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a> <span class="ex">---</span><span class="op">&gt;</span> 3ce5bd3a9572</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a><span class="ex">Step</span> 8/10 : ENV FLASK_APP=<span class="st">"new.py"</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a> <span class="ex">---</span><span class="op">&gt;</span> Running in b378d16bb605</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a><span class="ex">Removing</span> intermediate container b378d16bb605</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a> <span class="ex">---</span><span class="op">&gt;</span> e1f50490287b</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a><span class="ex">Step</span> 9/10 : EXPOSE 5000</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a> <span class="ex">---</span><span class="op">&gt;</span> Running in ab53c461d3de</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a><span class="ex">Removing</span> intermediate container ab53c461d3de</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a> <span class="ex">---</span><span class="op">&gt;</span> 0b86eca40a80</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a><span class="ex">Step</span> 10/10 : CMD [<span class="st">"flask"</span>, <span class="st">"run"</span>, <span class="st">"--host=0.0.0.0"</span>]</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a> <span class="ex">---</span><span class="op">&gt;</span> Running in 340eec151a51</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a><span class="ex">Removing</span> intermediate container 340eec151a51</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a> <span class="ex">---</span><span class="op">&gt;</span> 16d7a5b8db28</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a><span class="ex">Successfully</span> built 16d7a5b8db28</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a><span class="ex">Successfully</span> tagged myflaskapp:latest</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>L‚Äô√©tape de <em>build</em> a pris quelques secondes au lieu de plusieurs minutes, et les <em>logs</em> montrent bien l‚Äôutilisation du cache faite par <code>Docker</code> : les √©tapes pr√©c√©dant le changement r√©utilisent les couches cach√©es, mais celle d‚Äôapr√®s sont recalcul√©es.</p>
</section>
<section id="execution" class="level4">
<h4 class="anchored" data-anchor-id="execution">Ex√©cuter une image <code>Docker</code></h4>
<p>L‚Äô√©tape de <em>build</em> a permis de cr√©er une <em>image</em> <code>Docker</code>. Une image doit √™tre vue comme un <em>template</em> : elle permet d‚Äôex√©cuter l‚Äôapplication sur n‚Äôimporte quel environnement d‚Äôex√©cution sur lequel un moteur <code>Docker</code> est install√©. En l‚Äô√©tat, on a donc juste <em>construit</em>, mais rien <em>lanc√©</em> : notre application ne tourne pas encore. Pour cela, il faut cr√©er un <em>conteneur</em>, i.e.&nbsp;une instance vivante de l‚Äôimage qui permet d‚Äôacc√©der √† l‚Äôapplication. Cela se fait via la commande <code>docker run</code>.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> docker run <span class="at">-d</span> <span class="at">-p</span> 8000:5000 myflaskapp:latest</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="ex">6a2ab0d82d051a3829b182ede7b9152f7b692117d63fa013e7dfe6232f1b9e81</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>D√©taillons la syntaxe de cette commande :</p>
<ul>
<li><code>docker run tag</code> : lance l‚Äôimage dont on fournit le <em>tag</em>. Le <em>tag</em> est de la forme <code>repository/projet:version</code>. Ici, il n‚Äôy a pas de <em>repository</em> puisque tout est fait en local ;</li>
<li><code>-d</code> : ‚Äúd√©tache‚Äù le conteneur du terminal qui le lance ;</li>
<li><code>-p</code> : effectue un <em>mapping</em> entre un port de la machine qui ex√©cute le conteneur, et le conteneur lui-m√™me. Notre conteneur √©coute sur le port 5000, et l‚Äôon veut que notre application soit expos√©e sur le port 8000 de notre machine.</li>
</ul>
<p>Lorsque l‚Äôon ex√©cute <code>docker run</code>, <code>Docker</code> nous r√©pond simplement un <em>hash</em> qui identifie le conteneur que l‚Äôon a lanc√©. On peut v√©rifier qu‚Äôil tourne bien avec la commande <code>docker ps</code>, qui renvoie toutes les informations associ√©es au conteneur.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> docker ps</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="ex">CONTAINER</span> ID   IMAGE        COMMAND                  CREATED         STATUS         PORTS                                   NAMES</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="ex">6a2ab0d82d05</span>   myflaskapp   <span class="st">"flask run --host=0.‚Ä¶"</span>   7 seconds ago   Up 6 seconds   0.0.0.0:8000-<span class="op">&gt;</span>5000/tcp, :::8000-<span class="op">&gt;</span>5000/tcp   vigorous_kalam</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Les conteneurs peuvent √™tre utilis√©s pour r√©aliser des t√¢ches tr√®s diff√©rentes. Grossi√®rement, on peut distinguer deux situations :</p>
<ul>
<li>le conteneur effectue une t√¢che ‚Äúone-shot‚Äù, c‚Äôest √† dire une op√©ration qui a vocation √† s‚Äôeffectuer en un certain temps, suite √† quoi le conteneur peut s‚Äôarr√™ter ;</li>
<li>le conteneur ex√©cute une application. Dans ce cas, on souhaite que le conteneur reste en vie aussi longtemps que l‚Äôon souhaite utiliser l‚Äôapplication en question.</li>
</ul>
<p>Dans notre cas d‚Äôapplication, on se situe dans la seconde configuration puisque l‚Äôon veut ex√©cuter une application web. Lorsque l‚Äôapplication tourne, elle expose sur le <em>localhost</em>, accessible depuis un navigateur web ‚Äî en l‚Äôoccurence, √† l‚Äôadresse <a href="localhost:8000/">localhost:8000/</a>. Les calculs sont effectu√©s sur un serveur local, et le navigateur sert d‚Äôinterface avec l‚Äôutilisateur ‚Äî comme lorsque vous utilisez un notebook <code>Jupyter</code> par exemple.</p>
<p>Finalement, on a pu d√©velopper et ex√©cuter une application compl√®te sur notre environnement local, sans avoir eu √† installer quoi que ce soit sur notre machine personnelle, √† part <code>Docker.</code></p>
</section>
<section id="exp-docker" class="level4">
<h4 class="anchored" data-anchor-id="exp-docker">Exporter une image <code>Docker</code></h4>
<p>Jusqu‚Äô√† maintenant, toutes les commandes <code>Docker</code> que nous avons ex√©cut√©es se sont pass√©es en local. Ce mode de fonctionnement peut √™tre int√©ressant pour la phase de d√©veloppement. Mais comme on l‚Äôa vu, un des gros avantages de <code>Docker</code> est la facilit√© de redistribution des images construites, qui peuvent ensuite √™tre utilis√©es par de nombreux utilisateurs pour faire tourner notre application. Pour cela, il nous faut uploader notre image sur un d√©p√¥t distant, √† partir duquel les utilisateurs pourront la t√©l√©charger.</p>
<p>Plusieurs possibilit√©s existent selon le contexte de travail : une entreprise peut avoir un d√©p√¥t interne par exemple. Si le projet est open-source, on peut utiliser le <a href="https://hub.docker.com/">DockerHub</a>. Le <em>workflow</em> pour uploader une image est le suivant : - cr√©er un compte sur le DockerHub ; - cr√©er un projet (public) sur le DockerHub, qui va h√©berger les images <code>Docker</code> du projet ; - sur un terminal, utiliser <code>docker login</code> pour s‚Äôauthentifier au <code>DockerHub</code> ; - on va modifier le <em>tag</em> que l‚Äôon fournit lors du <em>build</em> pour sp√©cifier le chemin attendu. Dans notre cas : <code>docker build -t compte/projet:version .</code> ; - uploader l‚Äôimage avec <code>docker push compte/projet:version</code></p>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> docker push avouacr/myflaskapp:1.0.0</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="ex">The</span> push refers to repository <span class="pp">[</span><span class="ss">docker.io/avouacr/myflaskapp</span><span class="pp">]</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="ex">71db96687fe6:</span> Pushed </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="ex">624877ac887b:</span> Pushed </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="ex">ea4ab6b86e70:</span> Pushed </span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="ex">b5120a5bc48d:</span> Pushed </span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="ex">5fa484a3c9d8:</span> Pushed </span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="ex">c5ec52c98b31:</span> Pushed </span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="ex">1.0.0:</span> digest: sha256:b75fe53fd1990c3092ec41ab0966a9fbbb762f3047957d99327cc16e27c68cc9 size: 1574</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="imp-docker" class="level4">
<h4 class="anchored" data-anchor-id="imp-docker">Importer une image <code>Docker</code></h4>
<p>En supposant que le d√©p√¥t utilis√© pour uploader l‚Äôimage est public, la proc√©dure que doit suivre un utilisateur pour la t√©l√©charger se r√©sume √† utiliser la commande <code>docker pull compte/projet:version</code></p>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> docker pull avouacr/myflaskapp:1.0.0</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="ex">1.0.0:</span> Pulling from avouacr/myflaskapp</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="ex">e0b25ef51634:</span> Pull complete </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="ex">c0445e4b247e:</span> Pull complete </span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="ex">48ba4e71d1c2:</span> Pull complete </span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="ex">ffd728caa80a:</span> Pull complete </span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="ex">906a95f00510:</span> Pull complete </span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="ex">d7d49b6e17ab:</span> Pull complete </span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="ex">Digest:</span> sha256:b75fe53fd1990c3092ec41ab0966a9fbbb762f3047957d99327cc16e27c68cc9</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="ex">Status:</span> Downloaded newer image for avouacr/myflaskapp:1.0.0</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="ex">docker.io/avouacr/myflaskapp:1.0.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>Docker</code> t√©l√©charge et extrait chacune des couches qui constituent l‚Äôimage (ce qui peut parfois √™tre long). L‚Äôutilisateur peut alors cr√©er un conteneur √† partir de l‚Äôimage, en utilisant <code>docker run</code> comme illustr√© pr√©c√©demment.</p>
</section>
</section>
<section id="aide-m√©moire-1" class="level3">
<h3 class="anchored" data-anchor-id="aide-m√©moire-1">Aide-m√©moire</h3>
<p>Voici une premi√®re aide-m√©moire sur les principales commandes √† int√©grer dans un <code>Dockerfile</code>:</p>
<table class="table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th>Commande</th>
<th>Principe</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>FROM &lt;image&gt;:&lt;tag&gt;</code></td>
<td>Utiliser comme point de d√©part l‚Äôimage <code>&lt;image&gt;</code> ayant le tag <code>&lt;tag&gt;</code></td>
</tr>
<tr class="even">
<td><code>RUN &lt;instructions&gt;</code></td>
<td>Utiliser la suite d‚Äôinstructions <code>&lt;instructions&gt;</code> dans un terminal <code>Linux</code>. Pour passer plusieurs commandes dans un <code>RUN</code>, utiliser <code>&amp;&amp;</code>. Cette suite de commande peut avoir plusieurs lignes, dans ce cas, mettre <code>\</code> en fin de ligne</td>
</tr>
<tr class="odd">
<td><code>COPY &lt;source&gt; &lt;dest&gt;</code></td>
<td>R√©cup√©rer le fichier pr√©sent dans le syst√®me de fichier local √† l‚Äôemplacement <code>&lt;source&gt;</code> pour que les instructions ult√©rieures puissent le trouver √† l‚Äôemplacement <code>&lt;source&gt;</code></td>
</tr>
<tr class="even">
<td><code>ADD &lt;source&gt; &lt;dest&gt;</code></td>
<td>Globalement, m√™me r√¥le que <code>COPY</code></td>
</tr>
<tr class="odd">
<td><code>ENV MY_NAME="John Doe"</code></td>
<td>Cr√©ation d‚Äôune variable d‚Äôenvironnement (qui devient disponible sous l‚Äôalias <code>$MY_NAME</code>)</td>
</tr>
<tr class="even">
<td><code>WORKDIR &lt;path&gt;</code></td>
<td>D√©finir le <em>working directory</em> du conteuneur Docker dans le dossier <code>&lt;path&gt;</code></td>
</tr>
<tr class="odd">
<td><code>USER &lt;username&gt;</code></td>
<td>Cr√©ation d‚Äôun utilisateur non <em>root</em> nomm√© <code>&lt;username&gt;</code></td>
</tr>
<tr class="even">
<td><code>EXPOSE &lt;PORT_ID&gt;</code></td>
<td>Lorsqu‚Äôelle tournera, l‚Äôapplication sera disponible depuis le port <code>&lt;PORT_ID&gt;</code></td>
</tr>
<tr class="odd">
<td><code>CMD ["executable","param1","param2"]</code></td>
<td>Au lancement de l‚Äôinstance Docker la commande <code>executable</code> (par exemple <code>python3</code>) sera lanc√©e avec les param√®tres additionnels fournis</td>
</tr>
</tbody>
</table>
<p>Une seconde aide-m√©moire pour les principales commandes <code>Linux</code> est disponible ci-dessous:</p>
<table class="table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th>Commande</th>
<th>Principe</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>docker build . -t &lt;tag&gt;</code></td>
<td>Construire l‚Äôimage <code>Docker</code> √† partir des fichiers dans le r√©pertoire courant (<code>.</code>) en l‚Äôidentifiant avec le tag <code>&lt;tag&gt;</code></td>
</tr>
<tr class="even">
<td><code>docker run -it &lt;tag&gt;</code></td>
<td>Lancer l‚Äôinstance docker identifi√©e par <code>&lt;tag&gt;</code></td>
</tr>
<tr class="odd">
<td><code>docker images</code></td>
<td>Lister les images disponibles sur la machine et quelques unes de leurs propri√©t√©s (tags, volume, etc.)</td>
</tr>
<tr class="even">
<td><code>docker system prune</code></td>
<td>Faire un peu de m√©nage dans ses images <code>Docker</code> (bien r√©fl√©chir avant de faire tourner cette commande)</td>
</tr>
</tbody>
</table>


</section>
</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>La lenteur de l‚Äôinstallation des packages dans les environnements <code>conda</code> par rapport √† <code>pip</code> et l‚Äôacc√®s de plus en plus fr√©quent √† des <a href="https://pythonwheels.com/"><em>wheels</em></a> a permis un retour en gr√¢ce des environnements virtuels impl√©ment√©s par <code>venv</code>. Une autre alternative populaire est <a href="https://mamba.readthedocs.io/en/latest/"><code>mamba</code></a>, une r√©impl√©mentation de <code>Conda</code> en <code>C++</code> qui utilise un <em>solver</em> bien plus efficace. En proposant celui-ci, le projet <code>mamba</code> vise √† pallier l‚Äôun des irritants principaux de <code>conda</code>, √† savoir la lenteur du <em>solver</em>.<a href="#fnref1" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn2"><p>Ces r√©pertoires sont, dans le langage <code>conda</code> les <em>canaux</em>. Le canal par d√©faut est maintenu par les d√©veloppeurs d<code>Anaconda</code>. Cependant, pour en assurer la stabilit√©, ce canal a une forte inertie. La <code>conda-forge</code> a √©merg√© pour offrir plus de flexibilit√© aux d√©veloppeurs de <em>package</em> qui peuvent ainsi mettre √† disposition des versions plus r√©centes de leurs packages, comme sur <a href="https://pypi.org/">PyPI</a>.<a href="#fnref2" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn3"><p><a href="https://flask.palletsprojects.com/en/2.1.x/"><code>Flask</code></a> est un <em>framework</em> permettant de d√©ployer, de mani√®re l√©g√®re, des applications reposant sur <code>Python</code>.<a href="#fnref3" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn4"><p>Dans l‚Äôid√©al, on essaie de partir d‚Äôune couche la plus petite possible pour limiter la taille de l‚Äôimage finalement obtenue. Il n‚Äôest en effet pas n√©cessaire d‚Äôutiliser une image disposant de <code>R</code> si on n‚Äôutilise que du <code>Python</code>. En g√©n√©ral, les diff√©rents langages proposent des images de petite taille dans lequel un interpr√©teur est d√©j√† install√© et proprement configur√©. Dans cette application, on aurait par exemple pu utiliser l‚Äôimage <a href="https://hub.docker.com/layers/python/library/python/3.9-slim-buster/images/sha256-e07b35c0c81c21995a43cefd64730ac0e57a5164cc440b6a5c94c118cfacd0ca?context=explore">python:3.9-slim-buster</a>.<a href="#fnref4" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>